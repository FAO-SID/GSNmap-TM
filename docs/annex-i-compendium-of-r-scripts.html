<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Annex I: Compendium of R scripts |  Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)</title>
  <meta name="description" content="GSNmap - Technical Manual" />
  <meta name="generator" content="bookdown 0.33 and GitBook 2.6.7" />

  <meta property="og:title" content="Annex I: Compendium of R scripts |  Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="GSNmap - Technical Manual" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Annex I: Compendium of R scripts |  Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)" />
  
  <meta name="twitter:description" content="GSNmap - Technical Manual" />
  

<meta name="author" content="Angelini, M.E, Luotto, I., Rodriguez Lado, L., Mainka, M., Yigini, Y., Tong, Y." />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="way-forward.html"/>
<link rel="next" href="annex-ii-r-scripts-for-extra-functions.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.1.2/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.1.2/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="libs/plotly-binding-4.10.1/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Licence</a></li>
<li class="chapter" data-level="" data-path="abbreviations-and-acronyms.html"><a href="abbreviations-and-acronyms.html"><i class="fa fa-check"></i>Abbreviations and acronyms</a></li>
<li class="chapter" data-level="" data-path="contributors-and-reviewers.html"><a href="contributors-and-reviewers.html"><i class="fa fa-check"></i>Contributors and reviewers</a></li>
<li class="chapter" data-level="1" data-path="presentation.html"><a href="presentation.html"><i class="fa fa-check"></i><b>1</b> Presentation</a>
<ul>
<li class="chapter" data-level="1.1" data-path="presentation.html"><a href="presentation.html#background-and-objectives"><i class="fa fa-check"></i><b>1.1</b> Background and objectives</a></li>
<li class="chapter" data-level="1.2" data-path="presentation.html"><a href="presentation.html#global-soil-partnership"><i class="fa fa-check"></i><b>1.2</b> Global Soil Partnership</a></li>
<li class="chapter" data-level="1.3" data-path="presentation.html"><a href="presentation.html#country-driven-approach-and-tasks"><i class="fa fa-check"></i><b>1.3</b> Country-driven approach and tasks</a></li>
<li class="chapter" data-level="1.4" data-path="presentation.html"><a href="presentation.html#how-to-use-this-book"><i class="fa fa-check"></i><b>1.4</b> How to use this book</a></li>
<li class="chapter" data-level="1.5" data-path="presentation.html"><a href="presentation.html#training-material"><i class="fa fa-check"></i><b>1.5</b> Training material</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="soil-nutrients.html"><a href="soil-nutrients.html"><i class="fa fa-check"></i><b>2</b> Soil Nutrients</a>
<ul>
<li class="chapter" data-level="2.1" data-path="soil-nutrients.html"><a href="soil-nutrients.html#definition-of-soil-nutrients"><i class="fa fa-check"></i><b>2.1</b> Definition of soil nutrients</a></li>
<li class="chapter" data-level="2.2" data-path="soil-nutrients.html"><a href="soil-nutrients.html#soil-properties-governing-nutrient-availability"><i class="fa fa-check"></i><b>2.2</b> Soil properties governing nutrient availability</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html"><i class="fa fa-check"></i><b>3</b> Setting-up the software environment</a>
<ul>
<li class="chapter" data-level="3.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#use-of-r-rstudio-and-r-packages"><i class="fa fa-check"></i><b>3.1</b> Use of R, RStudio and R Packages</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-r"><i class="fa fa-check"></i><b>3.1.1</b> Obtaining and installing R</a></li>
<li class="chapter" data-level="3.1.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-rstudio"><i class="fa fa-check"></i><b>3.1.2</b> Obtaining and installing RStudio</a></li>
<li class="chapter" data-level="3.1.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#getting-started-with-r"><i class="fa fa-check"></i><b>3.1.3</b> Getting started with R</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#r-packages"><i class="fa fa-check"></i><b>3.2</b> R packages</a></li>
<li class="chapter" data-level="3.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#gee---google-earth-engine"><i class="fa fa-check"></i><b>3.3</b> GEE - google earth engine</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html"><i class="fa fa-check"></i><b>4</b> Digital Soil Mapping</a>
<ul>
<li class="chapter" data-level="4.1" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#principles"><i class="fa fa-check"></i><b>4.1</b> Principles</a></li>
<li class="chapter" data-level="4.2" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#environmental-covariates"><i class="fa fa-check"></i><b>4.2</b> Environmental covariates</a></li>
<li class="chapter" data-level="4.3" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#machine-learning-techniques"><i class="fa fa-check"></i><b>4.3</b> Machine learning techniques</a></li>
<li class="chapter" data-level="4.4" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#mapping-of-soil-nutrients-and-associated-soil-attributes"><i class="fa fa-check"></i><b>4.4</b> Mapping of soil nutrients and associated soil attributes</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html"><i class="fa fa-check"></i><b>5</b> Arranging soil data in <strong>R</strong></a>
<ul>
<li class="chapter" data-level="5.1" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#study-area-and-training-material"><i class="fa fa-check"></i><b>5.1</b> Study area and training material</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#georeferenced-topsoil-data"><i class="fa fa-check"></i><b>5.1.1</b> Georeferenced topsoil data</a></li>
<li class="chapter" data-level="5.1.2" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#soil-profile-data"><i class="fa fa-check"></i><b>5.1.2</b> Soil profile data</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#preproc"><i class="fa fa-check"></i><b>5.2</b> Format requirements of soil data</a></li>
<li class="chapter" data-level="5.3" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#pre-processing-steps"><i class="fa fa-check"></i><b>5.3</b> Pre-processing steps</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#set-the-scene-set-working-directory-packages-load-data"><i class="fa fa-check"></i><b>5.3.1</b> Set the scene (set working directory, packages, load data)</a></li>
<li class="chapter" data-level="5.3.2" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#basic-data-handling-operations"><i class="fa fa-check"></i><b>5.3.2</b> Basic data handling operations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html"><i class="fa fa-check"></i><b>6</b> Step 1: soil data preparation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#load-national-data"><i class="fa fa-check"></i><b>6.1</b> Load national data</a></li>
<li class="chapter" data-level="6.2" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#data-quality-check"><i class="fa fa-check"></i><b>6.2</b> Data quality check</a></li>
<li class="chapter" data-level="6.3" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#calculation-of-pedo-transfer-functions"><i class="fa fa-check"></i><b>6.3</b> Calculation of pedo-transfer functions</a></li>
<li class="chapter" data-level="6.4" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#check-for-outliers"><i class="fa fa-check"></i><b>6.4</b> Check for outliers</a></li>
<li class="chapter" data-level="6.5" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#harmonise-soil-layer-depths"><i class="fa fa-check"></i><b>6.5</b> Harmonise soil layer depths</a></li>
<li class="chapter" data-level="6.6" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#harmonise-units"><i class="fa fa-check"></i><b>6.6</b> Harmonise units</a></li>
<li class="chapter" data-level="6.7" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#save-the-results"><i class="fa fa-check"></i><b>6.7</b> Save the results</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html"><i class="fa fa-check"></i><b>7</b> Step 2: download environmental covariates</a>
<ul>
<li class="chapter" data-level="7.1" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#environmental-covariates-1"><i class="fa fa-check"></i><b>7.1</b> Environmental covariates</a></li>
<li class="chapter" data-level="7.2" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#download-covariatesand-cropland-mask-with-google-earth-engine-gee"><i class="fa fa-check"></i><b>7.2</b> Download covariatesand cropland mask with Google Earth Engine (GEE)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#assets"><i class="fa fa-check"></i><b>7.2.1</b> Assets</a></li>
<li class="chapter" data-level="7.2.2" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#define-the-region-of-interest-roi"><i class="fa fa-check"></i><b>7.2.2</b> Define the region of interest (ROI)</a></li>
<li class="chapter" data-level="7.2.3" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#load-and-clip-the-covariates"><i class="fa fa-check"></i><b>7.2.3</b> Load and clip the covariates</a></li>
<li class="chapter" data-level="7.2.4" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#clean-holes-in-fpar-layers"><i class="fa fa-check"></i><b>7.2.4</b> Clean holes in FPAR layers</a></li>
<li class="chapter" data-level="7.2.5" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#visualize-and-export-the-covariates"><i class="fa fa-check"></i><b>7.2.5</b> Visualize and export the covariates</a></li>
<li class="chapter" data-level="7.2.6" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#load-and-clip-the-copernicus-land-cover-map-and"><i class="fa fa-check"></i><b>7.2.6</b> Load and clip the Copernicus land cover map and</a></li>
<li class="chapter" data-level="7.2.7" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#reclassify-the-land-cover-map"><i class="fa fa-check"></i><b>7.2.7</b> Reclassify the land cover map</a></li>
<li class="chapter" data-level="7.2.8" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#visualization-and-exporting-mask"><i class="fa fa-check"></i><b>7.2.8</b> Visualization and exporting mask</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#run-and-export-in-gee"><i class="fa fa-check"></i><b>7.3</b> Run and export in GEE</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html"><i class="fa fa-check"></i><b>8</b> Step 3: Mapping continuous soil properties</a>
<ul>
<li class="chapter" data-level="8.1" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#getting-prepared-to-map"><i class="fa fa-check"></i><b>8.1</b> Getting prepared to map</a></li>
<li class="chapter" data-level="8.2" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#covariate-selection-and-repeated-k-fold-cross-validation"><i class="fa fa-check"></i><b>8.2</b> Covariate selection and repeated k-fold cross-validation</a></li>
<li class="chapter" data-level="8.3" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#model-calibration"><i class="fa fa-check"></i><b>8.3</b> Model calibration</a></li>
<li class="chapter" data-level="8.4" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#uncertainty-assessment"><i class="fa fa-check"></i><b>8.4</b> Uncertainty assessment</a></li>
<li class="chapter" data-level="8.5" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#predicting-soil-attributes"><i class="fa fa-check"></i><b>8.5</b> Predicting soil attributes</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="reporting-results.html"><a href="reporting-results.html"><i class="fa fa-check"></i><b>9</b> Reporting results</a>
<ul>
<li class="chapter" data-level="9.1" data-path="reporting-results.html"><a href="reporting-results.html#data-submission-form"><i class="fa fa-check"></i><b>9.1</b> Data submission form</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="way-forward.html"><a href="way-forward.html"><i class="fa fa-check"></i><b>10</b> Way forward</a>
<ul>
<li class="chapter" data-level="10.1" data-path="way-forward.html"><a href="way-forward.html#frequent-asked-questions-and-troubleshooting-answers"><i class="fa fa-check"></i><b>10.1</b> Frequent asked questions and Troubleshooting answers</a></li>
<li class="chapter" data-level="10.2" data-path="way-forward.html"><a href="way-forward.html#issues-in-the-gsnmap-technical-manual"><i class="fa fa-check"></i><b>10.2</b> Issues in the GSNmap Technical Manual</a></li>
<li class="chapter" data-level="10.3" data-path="way-forward.html"><a href="way-forward.html#get-help"><i class="fa fa-check"></i><b>10.3</b> Get help</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html"><i class="fa fa-check"></i>Annex I: Compendium of R scripts</a>
<ul>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-0-introduction-to-r"><i class="fa fa-check"></i>Script 0: Introduction to R</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-2-data-preparation"><i class="fa fa-check"></i>Script 2: Data preparation</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#scripts-3-download-environmental-covariates"><i class="fa fa-check"></i>Scripts 3: Download environmental covariates</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-4-modelling-validation-and-prediction-using-soil-data-with-coordinates"><i class="fa fa-check"></i>Script 4: Modelling, validation and prediction using soil data with coordinates</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="annex-ii-r-scripts-for-extra-functions.html"><a href="annex-ii-r-scripts-for-extra-functions.html"><i class="fa fa-check"></i>Annex II: R scripts for extra functions</a></li>
<li class="chapter" data-level="" data-path="annex-iii-mapping-without-point-coordinates.html"><a href="annex-iii-mapping-without-point-coordinates.html"><i class="fa fa-check"></i>Annex III: Mapping without point coordinates</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html"><i class="fa fa-check"></i>Annex IV: Quality assurance and quality control</a>
<ul>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#step-1-completeness-of-layers"><i class="fa fa-check"></i>Step 1: Completeness of layers</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#step-2-check-the-projection-and-resolution-of-all-data-products"><i class="fa fa-check"></i>Step 2: Check the projection and resolution of all data products</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#step-3-check-the-extent"><i class="fa fa-check"></i>Step 3: Check the extent</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#step-4-check-the-units-ranges-and-outliers"><i class="fa fa-check"></i>Step 4: Check the units, ranges, and outliers</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><p><img src="images/frontcover.jpg" style="top:0px;height:100px;" align="right" />
Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)</p></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="annex-i-compendium-of-r-scripts" class="section level1 unnumbered hasAnchor">
<h1>Annex I: Compendium of R scripts<a href="annex-i-compendium-of-r-scripts.html#annex-i-compendium-of-r-scripts" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter contains the complete list of R scripts to run the process of mapping soil nutrient and associated soil properties.</p>
<div id="script-0-introduction-to-r" class="section level2 unnumbered hasAnchor">
<h2>Script 0: Introduction to R<a href="annex-i-compendium-of-r-scripts.html#script-0-introduction-to-r" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="annex-i-compendium-of-r-scripts.html#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Introduction to R</span></span>
<span id="cb113-2"><a href="annex-i-compendium-of-r-scripts.html#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="annex-i-compendium-of-r-scripts.html#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 0. Playground ================================================================</span></span>
<span id="cb113-4"><a href="annex-i-compendium-of-r-scripts.html#cb113-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-5"><a href="annex-i-compendium-of-r-scripts.html#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="co"># learn important keyboard shortcuts</span></span>
<span id="cb113-6"><a href="annex-i-compendium-of-r-scripts.html#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ctrl + enter for running code</span></span>
<span id="cb113-7"><a href="annex-i-compendium-of-r-scripts.html#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="co"># tab after writing the first three characters of the function name</span></span>
<span id="cb113-8"><a href="annex-i-compendium-of-r-scripts.html#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="co"># F1 to access the help</span></span>
<span id="cb113-9"><a href="annex-i-compendium-of-r-scripts.html#cb113-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-10"><a href="annex-i-compendium-of-r-scripts.html#cb113-10" aria-hidden="true" tabindex="-1"></a><span class="co"># explore the use of &lt;-, $, [], ==, !=, c(), :, data.frame(), list(), as.factor()</span></span>
<span id="cb113-11"><a href="annex-i-compendium-of-r-scripts.html#cb113-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-12"><a href="annex-i-compendium-of-r-scripts.html#cb113-12" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">15</span></span>
<span id="cb113-13"><a href="annex-i-compendium-of-r-scripts.html#cb113-13" aria-hidden="true" tabindex="-1"></a>a[<span class="dv">2</span>]</span>
<span id="cb113-14"><a href="annex-i-compendium-of-r-scripts.html#cb113-14" aria-hidden="true" tabindex="-1"></a>a[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb113-15"><a href="annex-i-compendium-of-r-scripts.html#cb113-15" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;a&quot;</span>, a )</span>
<span id="cb113-16"><a href="annex-i-compendium-of-r-scripts.html#cb113-16" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(b)</span>
<span id="cb113-17"><a href="annex-i-compendium-of-r-scripts.html#cb113-17" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">column_a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="at">column_b =</span> b)</span>
<span id="cb113-18"><a href="annex-i-compendium-of-r-scripts.html#cb113-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-19"><a href="annex-i-compendium-of-r-scripts.html#cb113-19" aria-hidden="true" tabindex="-1"></a>df[,<span class="dv">1</span>]</span>
<span id="cb113-20"><a href="annex-i-compendium-of-r-scripts.html#cb113-20" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>column_b</span>
<span id="cb113-21"><a href="annex-i-compendium-of-r-scripts.html#cb113-21" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(df<span class="sc">$</span>column_b)</span>
<span id="cb113-22"><a href="annex-i-compendium-of-r-scripts.html#cb113-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(df)</span>
<span id="cb113-23"><a href="annex-i-compendium-of-r-scripts.html#cb113-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-24"><a href="annex-i-compendium-of-r-scripts.html#cb113-24" aria-hidden="true" tabindex="-1"></a>df[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,]</span>
<span id="cb113-25"><a href="annex-i-compendium-of-r-scripts.html#cb113-25" aria-hidden="true" tabindex="-1"></a>df[,<span class="dv">1</span>]</span>
<span id="cb113-26"><a href="annex-i-compendium-of-r-scripts.html#cb113-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-27"><a href="annex-i-compendium-of-r-scripts.html#cb113-27" aria-hidden="true" tabindex="-1"></a><span class="fu">as.factor</span>(b)</span>
<span id="cb113-28"><a href="annex-i-compendium-of-r-scripts.html#cb113-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-29"><a href="annex-i-compendium-of-r-scripts.html#cb113-29" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">list</span>(a, b, df)</span>
<span id="cb113-30"><a href="annex-i-compendium-of-r-scripts.html#cb113-30" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb113-31"><a href="annex-i-compendium-of-r-scripts.html#cb113-31" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(d)</span>
<span id="cb113-32"><a href="annex-i-compendium-of-r-scripts.html#cb113-32" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(d) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;numeric_vector&quot;</span>, <span class="st">&quot;character_vector&quot;</span>, <span class="st">&quot;dataframe&quot;</span>)</span>
<span id="cb113-33"><a href="annex-i-compendium-of-r-scripts.html#cb113-33" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb113-34"><a href="annex-i-compendium-of-r-scripts.html#cb113-34" aria-hidden="true" tabindex="-1"></a>d[[<span class="dv">1</span>]]</span>
<span id="cb113-35"><a href="annex-i-compendium-of-r-scripts.html#cb113-35" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>numeric_vector</span>
<span id="cb113-36"><a href="annex-i-compendium-of-r-scripts.html#cb113-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-37"><a href="annex-i-compendium-of-r-scripts.html#cb113-37" aria-hidden="true" tabindex="-1"></a>a <span class="sc">==</span> b</span>
<span id="cb113-38"><a href="annex-i-compendium-of-r-scripts.html#cb113-38" aria-hidden="true" tabindex="-1"></a>a <span class="sc">!=</span> b</span>
<span id="cb113-39"><a href="annex-i-compendium-of-r-scripts.html#cb113-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-40"><a href="annex-i-compendium-of-r-scripts.html#cb113-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Set working directory ===================================================== </span></span>
<span id="cb113-41"><a href="annex-i-compendium-of-r-scripts.html#cb113-41" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;C:/GIT/Digital-Soil-Mapping/&quot;</span>)</span>
<span id="cb113-42"><a href="annex-i-compendium-of-r-scripts.html#cb113-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-43"><a href="annex-i-compendium-of-r-scripts.html#cb113-43" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Install and load packages =================================================</span></span>
<span id="cb113-44"><a href="annex-i-compendium-of-r-scripts.html#cb113-44" aria-hidden="true" tabindex="-1"></a><span class="co"># readxl, tidyverse, and data.table packages using the functions</span></span>
<span id="cb113-45"><a href="annex-i-compendium-of-r-scripts.html#cb113-45" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;tidyverse&quot;</span>)</span>
<span id="cb113-46"><a href="annex-i-compendium-of-r-scripts.html#cb113-46" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;readxl&quot;</span>)</span>
<span id="cb113-47"><a href="annex-i-compendium-of-r-scripts.html#cb113-47" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;data.table&quot;</span>)</span>
<span id="cb113-48"><a href="annex-i-compendium-of-r-scripts.html#cb113-48" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb113-49"><a href="annex-i-compendium-of-r-scripts.html#cb113-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb113-50"><a href="annex-i-compendium-of-r-scripts.html#cb113-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb113-51"><a href="annex-i-compendium-of-r-scripts.html#cb113-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-52"><a href="annex-i-compendium-of-r-scripts.html#cb113-52" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Import an spreadsheet =====================================================</span></span>
<span id="cb113-53"><a href="annex-i-compendium-of-r-scripts.html#cb113-53" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.1 Read the MS Excel file --------------------------------------------------</span></span>
<span id="cb113-54"><a href="annex-i-compendium-of-r-scripts.html#cb113-54" aria-hidden="true" tabindex="-1"></a><span class="co">#Read the soil_data.xlsx file, spreadsheet 2, using read_excel </span></span>
<span id="cb113-55"><a href="annex-i-compendium-of-r-scripts.html#cb113-55" aria-hidden="true" tabindex="-1"></a><span class="fu">read_excel</span>(<span class="at">path =</span> <span class="st">&quot;01-Data/soil_data.xlsx&quot;</span>, <span class="at">sheet =</span> <span class="dv">2</span>)</span>
<span id="cb113-56"><a href="annex-i-compendium-of-r-scripts.html#cb113-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-57"><a href="annex-i-compendium-of-r-scripts.html#cb113-57" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.2 Read the csv file with the native function ------------------------------</span></span>
<span id="cb113-58"><a href="annex-i-compendium-of-r-scripts.html#cb113-58" aria-hidden="true" tabindex="-1"></a><span class="co"># 01-Data/horizon.csv</span></span>
<span id="cb113-59"><a href="annex-i-compendium-of-r-scripts.html#cb113-59" aria-hidden="true" tabindex="-1"></a><span class="fu">read.csv</span>(<span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb113-60"><a href="annex-i-compendium-of-r-scripts.html#cb113-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-61"><a href="annex-i-compendium-of-r-scripts.html#cb113-61" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.3 Read the csv file with the tidyverse function ---------------------------</span></span>
<span id="cb113-62"><a href="annex-i-compendium-of-r-scripts.html#cb113-62" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb113-63"><a href="annex-i-compendium-of-r-scripts.html#cb113-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-64"><a href="annex-i-compendium-of-r-scripts.html#cb113-64" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.4 Read the csv file with the data.table function --------------------------</span></span>
<span id="cb113-65"><a href="annex-i-compendium-of-r-scripts.html#cb113-65" aria-hidden="true" tabindex="-1"></a><span class="fu">fread</span>(<span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb113-66"><a href="annex-i-compendium-of-r-scripts.html#cb113-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-67"><a href="annex-i-compendium-of-r-scripts.html#cb113-67" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.5 Assign the dataframe to an object called dat ----------------------------</span></span>
<span id="cb113-68"><a href="annex-i-compendium-of-r-scripts.html#cb113-68" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb113-69"><a href="annex-i-compendium-of-r-scripts.html#cb113-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-70"><a href="annex-i-compendium-of-r-scripts.html#cb113-70" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Tidyverse functions =======================================================</span></span>
<span id="cb113-71"><a href="annex-i-compendium-of-r-scripts.html#cb113-71" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.1 Select pid, hip, top, bottom, ph_h2o, cec from dat ---------------------</span></span>
<span id="cb113-72"><a href="annex-i-compendium-of-r-scripts.html#cb113-72" aria-hidden="true" tabindex="-1"></a>dat_1 <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb113-73"><a href="annex-i-compendium-of-r-scripts.html#cb113-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id_prof, id_hor, top, bottom, ph_h2o, cec)</span>
<span id="cb113-74"><a href="annex-i-compendium-of-r-scripts.html#cb113-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-75"><a href="annex-i-compendium-of-r-scripts.html#cb113-75" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.2 Filter: pick observations by their values -------------------------------</span></span>
<span id="cb113-76"><a href="annex-i-compendium-of-r-scripts.html#cb113-76" aria-hidden="true" tabindex="-1"></a><span class="co"># filter observations with cec &gt; 50 cmolc/100g</span></span>
<span id="cb113-77"><a href="annex-i-compendium-of-r-scripts.html#cb113-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-78"><a href="annex-i-compendium-of-r-scripts.html#cb113-78" aria-hidden="true" tabindex="-1"></a>dat_2 <span class="ot">&lt;-</span> dat_1 <span class="sc">%&gt;%</span> </span>
<span id="cb113-79"><a href="annex-i-compendium-of-r-scripts.html#cb113-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(cec <span class="sc">&gt;</span> <span class="dv">30</span>)</span>
<span id="cb113-80"><a href="annex-i-compendium-of-r-scripts.html#cb113-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-81"><a href="annex-i-compendium-of-r-scripts.html#cb113-81" aria-hidden="true" tabindex="-1"></a>dat_2</span>
<span id="cb113-82"><a href="annex-i-compendium-of-r-scripts.html#cb113-82" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.3 Mutate: create a new variable -------------------------------------------</span></span>
<span id="cb113-83"><a href="annex-i-compendium-of-r-scripts.html#cb113-83" aria-hidden="true" tabindex="-1"></a><span class="co"># thickness = top - bottom</span></span>
<span id="cb113-84"><a href="annex-i-compendium-of-r-scripts.html#cb113-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-85"><a href="annex-i-compendium-of-r-scripts.html#cb113-85" aria-hidden="true" tabindex="-1"></a>dat_3 <span class="ot">&lt;-</span> dat_2 <span class="sc">%&gt;%</span> </span>
<span id="cb113-86"><a href="annex-i-compendium-of-r-scripts.html#cb113-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">thickness =</span> bottom <span class="sc">-</span> top)</span>
<span id="cb113-87"><a href="annex-i-compendium-of-r-scripts.html#cb113-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-88"><a href="annex-i-compendium-of-r-scripts.html#cb113-88" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.4 Group_by and summarise --------------------------------------------------</span></span>
<span id="cb113-89"><a href="annex-i-compendium-of-r-scripts.html#cb113-89" aria-hidden="true" tabindex="-1"></a><span class="co"># group by variable pid</span></span>
<span id="cb113-90"><a href="annex-i-compendium-of-r-scripts.html#cb113-90" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise taking the mean of pH and cec</span></span>
<span id="cb113-91"><a href="annex-i-compendium-of-r-scripts.html#cb113-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-92"><a href="annex-i-compendium-of-r-scripts.html#cb113-92" aria-hidden="true" tabindex="-1"></a>dat_4 <span class="ot">&lt;-</span> dat_3 <span class="sc">%&gt;%</span> </span>
<span id="cb113-93"><a href="annex-i-compendium-of-r-scripts.html#cb113-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id_prof) <span class="sc">%&gt;%</span> </span>
<span id="cb113-94"><a href="annex-i-compendium-of-r-scripts.html#cb113-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_ph =</span> <span class="fu">mean</span>(ph_h2o),</span>
<span id="cb113-95"><a href="annex-i-compendium-of-r-scripts.html#cb113-95" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_cec =</span> <span class="fu">mean</span>(cec))</span>
<span id="cb113-96"><a href="annex-i-compendium-of-r-scripts.html#cb113-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-97"><a href="annex-i-compendium-of-r-scripts.html#cb113-97" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.5 Reshape the table using pivot_longer ------------------------------------</span></span>
<span id="cb113-98"><a href="annex-i-compendium-of-r-scripts.html#cb113-98" aria-hidden="true" tabindex="-1"></a><span class="co"># use dat_3</span></span>
<span id="cb113-99"><a href="annex-i-compendium-of-r-scripts.html#cb113-99" aria-hidden="true" tabindex="-1"></a><span class="co"># put the names of the variables ph_h2o, cec and thickness in the column </span></span>
<span id="cb113-100"><a href="annex-i-compendium-of-r-scripts.html#cb113-100" aria-hidden="true" tabindex="-1"></a><span class="co"># variable and keep the rest of the table. Save in dat_5 </span></span>
<span id="cb113-101"><a href="annex-i-compendium-of-r-scripts.html#cb113-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-102"><a href="annex-i-compendium-of-r-scripts.html#cb113-102" aria-hidden="true" tabindex="-1"></a>dat_5 <span class="ot">&lt;-</span> dat_3 <span class="sc">%&gt;%</span> </span>
<span id="cb113-103"><a href="annex-i-compendium-of-r-scripts.html#cb113-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(ph_h2o<span class="sc">:</span>thickness, <span class="at">names_to =</span> <span class="st">&quot;soil_property&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>)</span>
<span id="cb113-104"><a href="annex-i-compendium-of-r-scripts.html#cb113-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-105"><a href="annex-i-compendium-of-r-scripts.html#cb113-105" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.6 Join the table sites.csv with dat_3 -------------------------------------</span></span>
<span id="cb113-106"><a href="annex-i-compendium-of-r-scripts.html#cb113-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Load soil_phys_data030.csv (in 01-Data folder) </span></span>
<span id="cb113-107"><a href="annex-i-compendium-of-r-scripts.html#cb113-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Join its columns with dat_3 keeping all the rows of dat_3</span></span>
<span id="cb113-108"><a href="annex-i-compendium-of-r-scripts.html#cb113-108" aria-hidden="true" tabindex="-1"></a><span class="co"># save the result as dat_6</span></span>
<span id="cb113-109"><a href="annex-i-compendium-of-r-scripts.html#cb113-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-110"><a href="annex-i-compendium-of-r-scripts.html#cb113-110" aria-hidden="true" tabindex="-1"></a>phys <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;01-Data/soil_phys_data030.csv&quot;</span>)</span>
<span id="cb113-111"><a href="annex-i-compendium-of-r-scripts.html#cb113-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-112"><a href="annex-i-compendium-of-r-scripts.html#cb113-112" aria-hidden="true" tabindex="-1"></a>phys <span class="ot">&lt;-</span> phys <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">id_prof =</span> <span class="st">&quot;ProfID&quot;</span>)</span>
<span id="cb113-113"><a href="annex-i-compendium-of-r-scripts.html#cb113-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-114"><a href="annex-i-compendium-of-r-scripts.html#cb113-114" aria-hidden="true" tabindex="-1"></a>dat_6 <span class="ot">&lt;-</span> dat_3 <span class="sc">%&gt;%</span> </span>
<span id="cb113-115"><a href="annex-i-compendium-of-r-scripts.html#cb113-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(phys)</span>
<span id="cb113-116"><a href="annex-i-compendium-of-r-scripts.html#cb113-116" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb113-117"><a href="annex-i-compendium-of-r-scripts.html#cb113-117" aria-hidden="true" tabindex="-1"></a>dat_6 <span class="ot">&lt;-</span> phys <span class="sc">%&gt;%</span> </span>
<span id="cb113-118"><a href="annex-i-compendium-of-r-scripts.html#cb113-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(dat_3)</span>
<span id="cb113-119"><a href="annex-i-compendium-of-r-scripts.html#cb113-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-120"><a href="annex-i-compendium-of-r-scripts.html#cb113-120" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Data visualization with ggplot2 ===========================================</span></span>
<span id="cb113-121"><a href="annex-i-compendium-of-r-scripts.html#cb113-121" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.1 1D plot: histograms -----------------------------------------------------</span></span>
<span id="cb113-122"><a href="annex-i-compendium-of-r-scripts.html#cb113-122" aria-hidden="true" tabindex="-1"></a><span class="co"># histograms of cec and ph_h2o</span></span>
<span id="cb113-123"><a href="annex-i-compendium-of-r-scripts.html#cb113-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-124"><a href="annex-i-compendium-of-r-scripts.html#cb113-124" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x=</span>cec)) <span class="sc">+</span> <span class="fu">geom_histogram</span>()</span>
<span id="cb113-125"><a href="annex-i-compendium-of-r-scripts.html#cb113-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-126"><a href="annex-i-compendium-of-r-scripts.html#cb113-126" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.2 2D plot: scatterplot ----------------------------------------------------</span></span>
<span id="cb113-127"><a href="annex-i-compendium-of-r-scripts.html#cb113-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot bottom vs. ph_h2o</span></span>
<span id="cb113-128"><a href="annex-i-compendium-of-r-scripts.html#cb113-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-129"><a href="annex-i-compendium-of-r-scripts.html#cb113-129" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x =</span> bottom, <span class="at">y =</span> ph_h2o)) <span class="sc">+</span> </span>
<span id="cb113-130"><a href="annex-i-compendium-of-r-scripts.html#cb113-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() </span>
<span id="cb113-131"><a href="annex-i-compendium-of-r-scripts.html#cb113-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-132"><a href="annex-i-compendium-of-r-scripts.html#cb113-132" aria-hidden="true" tabindex="-1"></a><span class="co"># add a fitting line</span></span>
<span id="cb113-133"><a href="annex-i-compendium-of-r-scripts.html#cb113-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-134"><a href="annex-i-compendium-of-r-scripts.html#cb113-134" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x =</span> bottom, <span class="at">y =</span> ph_h2o)) <span class="sc">+</span> </span>
<span id="cb113-135"><a href="annex-i-compendium-of-r-scripts.html#cb113-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb113-136"><a href="annex-i-compendium-of-r-scripts.html#cb113-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span> )</span>
<span id="cb113-137"><a href="annex-i-compendium-of-r-scripts.html#cb113-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-138"><a href="annex-i-compendium-of-r-scripts.html#cb113-138" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.3 3D plot: scatterplot ----------------------------------------------------</span></span>
<span id="cb113-139"><a href="annex-i-compendium-of-r-scripts.html#cb113-139" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot bottom vs. ph_h2o, add clay as color and size inside the </span></span>
<span id="cb113-140"><a href="annex-i-compendium-of-r-scripts.html#cb113-140" aria-hidden="true" tabindex="-1"></a><span class="co"># function aes()</span></span>
<span id="cb113-141"><a href="annex-i-compendium-of-r-scripts.html#cb113-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-142"><a href="annex-i-compendium-of-r-scripts.html#cb113-142" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat_3, <span class="fu">aes</span>(<span class="at">x =</span> bottom, <span class="at">y =</span> ph_h2o, <span class="at">color =</span> cec, <span class="at">size =</span> cec)) <span class="sc">+</span> </span>
<span id="cb113-143"><a href="annex-i-compendium-of-r-scripts.html#cb113-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span>
<span id="cb113-144"><a href="annex-i-compendium-of-r-scripts.html#cb113-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-145"><a href="annex-i-compendium-of-r-scripts.html#cb113-145" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Geospatial data with terra ================================================</span></span>
<span id="cb113-146"><a href="annex-i-compendium-of-r-scripts.html#cb113-146" aria-hidden="true" tabindex="-1"></a><span class="do">## Load packages (install them if needed)</span></span>
<span id="cb113-147"><a href="annex-i-compendium-of-r-scripts.html#cb113-147" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb113-148"><a href="annex-i-compendium-of-r-scripts.html#cb113-148" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.1 Load a raster and a vector layer ----------------------------------------</span></span>
<span id="cb113-149"><a href="annex-i-compendium-of-r-scripts.html#cb113-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Load 01-Data/covs/grass.tif using rast() function, then plot it</span></span>
<span id="cb113-150"><a href="annex-i-compendium-of-r-scripts.html#cb113-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Load 01-Data/soil map/SoilTypes.shp using vect() function and plot it </span></span>
<span id="cb113-151"><a href="annex-i-compendium-of-r-scripts.html#cb113-151" aria-hidden="true" tabindex="-1"></a><span class="co"># explore the attributes of these layers</span></span>
<span id="cb113-152"><a href="annex-i-compendium-of-r-scripts.html#cb113-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-153"><a href="annex-i-compendium-of-r-scripts.html#cb113-153" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;01-Data/Macedonia/grass.tif&quot;</span>)</span>
<span id="cb113-154"><a href="annex-i-compendium-of-r-scripts.html#cb113-154" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r)</span>
<span id="cb113-155"><a href="annex-i-compendium-of-r-scripts.html#cb113-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-156"><a href="annex-i-compendium-of-r-scripts.html#cb113-156" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">vect</span>(<span class="st">&quot;01-Data/Macedonia/SoilTypes.shp&quot;</span>)</span>
<span id="cb113-157"><a href="annex-i-compendium-of-r-scripts.html#cb113-157" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v)</span>
<span id="cb113-158"><a href="annex-i-compendium-of-r-scripts.html#cb113-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-159"><a href="annex-i-compendium-of-r-scripts.html#cb113-159" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.2 Load a raster and a vector layer ----------------------------------------</span></span>
<span id="cb113-160"><a href="annex-i-compendium-of-r-scripts.html#cb113-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the current CRS (EPSG) of the raster and the vector. </span></span>
<span id="cb113-161"><a href="annex-i-compendium-of-r-scripts.html#cb113-161" aria-hidden="true" tabindex="-1"></a><span class="co"># Find a *projected* CRS in http://epsg.io for Macedonia and copy the number</span></span>
<span id="cb113-162"><a href="annex-i-compendium-of-r-scripts.html#cb113-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the Arguments of function project (?project) that need to be defined</span></span>
<span id="cb113-163"><a href="annex-i-compendium-of-r-scripts.html#cb113-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the new object as r_proj and v_proj</span></span>
<span id="cb113-164"><a href="annex-i-compendium-of-r-scripts.html#cb113-164" aria-hidden="true" tabindex="-1"></a><span class="co"># plot both objects</span></span>
<span id="cb113-165"><a href="annex-i-compendium-of-r-scripts.html#cb113-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-166"><a href="annex-i-compendium-of-r-scripts.html#cb113-166" aria-hidden="true" tabindex="-1"></a>r_proj <span class="ot">&lt;-</span> <span class="fu">project</span>(<span class="at">x =</span> r, <span class="at">y =</span> <span class="st">&quot;epsg:6204&quot;</span>, <span class="at">method =</span> <span class="st">&quot;bilinear&quot;</span>, <span class="at">res =</span> <span class="dv">250</span>)</span>
<span id="cb113-167"><a href="annex-i-compendium-of-r-scripts.html#cb113-167" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_proj)</span>
<span id="cb113-168"><a href="annex-i-compendium-of-r-scripts.html#cb113-168" aria-hidden="true" tabindex="-1"></a>v_proj <span class="ot">&lt;-</span> <span class="fu">project</span>(<span class="at">x =</span> v, <span class="at">y =</span> <span class="st">&quot;epsg:6204&quot;</span>)</span>
<span id="cb113-169"><a href="annex-i-compendium-of-r-scripts.html#cb113-169" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v_proj, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb113-170"><a href="annex-i-compendium-of-r-scripts.html#cb113-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-171"><a href="annex-i-compendium-of-r-scripts.html#cb113-171" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.3 Cropping and masking a raster -------------------------------------------</span></span>
<span id="cb113-172"><a href="annex-i-compendium-of-r-scripts.html#cb113-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the area of the polygons in v_proj (search for a function) and</span></span>
<span id="cb113-173"><a href="annex-i-compendium-of-r-scripts.html#cb113-173" aria-hidden="true" tabindex="-1"></a><span class="co"># assign the values to a new column named area</span></span>
<span id="cb113-174"><a href="annex-i-compendium-of-r-scripts.html#cb113-174" aria-hidden="true" tabindex="-1"></a><span class="co"># select the largest polygon using [], $, == and max() func. and save it as pol</span></span>
<span id="cb113-175"><a href="annex-i-compendium-of-r-scripts.html#cb113-175" aria-hidden="true" tabindex="-1"></a><span class="co"># crop the raster with pol using the crop() function and save it as r_pol</span></span>
<span id="cb113-176"><a href="annex-i-compendium-of-r-scripts.html#cb113-176" aria-hidden="true" tabindex="-1"></a><span class="co"># mask the raster r_pol with the polygon pol and save it with the same name</span></span>
<span id="cb113-177"><a href="annex-i-compendium-of-r-scripts.html#cb113-177" aria-hidden="true" tabindex="-1"></a><span class="co"># plot each result</span></span>
<span id="cb113-178"><a href="annex-i-compendium-of-r-scripts.html#cb113-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-179"><a href="annex-i-compendium-of-r-scripts.html#cb113-179" aria-hidden="true" tabindex="-1"></a>v_proj<span class="sc">$</span>area <span class="ot">&lt;-</span> <span class="fu">expanse</span>(v_proj, <span class="at">unit =</span> <span class="st">&quot;ha&quot;</span>)</span>
<span id="cb113-180"><a href="annex-i-compendium-of-r-scripts.html#cb113-180" aria-hidden="true" tabindex="-1"></a>pol <span class="ot">&lt;-</span> v_proj[v_proj<span class="sc">$</span>area <span class="sc">==</span> <span class="fu">max</span>(v_proj<span class="sc">$</span>area)]</span>
<span id="cb113-181"><a href="annex-i-compendium-of-r-scripts.html#cb113-181" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol)</span>
<span id="cb113-182"><a href="annex-i-compendium-of-r-scripts.html#cb113-182" aria-hidden="true" tabindex="-1"></a>r_pol <span class="ot">&lt;-</span> <span class="fu">crop</span>(r_proj, pol)</span>
<span id="cb113-183"><a href="annex-i-compendium-of-r-scripts.html#cb113-183" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_pol)</span>
<span id="cb113-184"><a href="annex-i-compendium-of-r-scripts.html#cb113-184" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb113-185"><a href="annex-i-compendium-of-r-scripts.html#cb113-185" aria-hidden="true" tabindex="-1"></a>r_pol <span class="ot">&lt;-</span> <span class="fu">mask</span>(r_pol, pol)</span>
<span id="cb113-186"><a href="annex-i-compendium-of-r-scripts.html#cb113-186" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_pol)</span>
<span id="cb113-187"><a href="annex-i-compendium-of-r-scripts.html#cb113-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-188"><a href="annex-i-compendium-of-r-scripts.html#cb113-188" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.4 Replace values in a raster by filtering their cells ---------------------</span></span>
<span id="cb113-189"><a href="annex-i-compendium-of-r-scripts.html#cb113-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore the following link to understand how terra manage cell values</span></span>
<span id="cb113-190"><a href="annex-i-compendium-of-r-scripts.html#cb113-190" aria-hidden="true" tabindex="-1"></a><span class="co"># https://rspatial.org/terra/pkg/4-algebra.html </span></span>
<span id="cb113-191"><a href="annex-i-compendium-of-r-scripts.html#cb113-191" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace values lower than 5 in r+pol by 0</span></span>
<span id="cb113-192"><a href="annex-i-compendium-of-r-scripts.html#cb113-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-193"><a href="annex-i-compendium-of-r-scripts.html#cb113-193" aria-hidden="true" tabindex="-1"></a>r_pol[r_pol<span class="sc">$</span>grass <span class="sc">&lt;</span> <span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb113-194"><a href="annex-i-compendium-of-r-scripts.html#cb113-194" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_pol)</span>
<span id="cb113-195"><a href="annex-i-compendium-of-r-scripts.html#cb113-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-196"><a href="annex-i-compendium-of-r-scripts.html#cb113-196" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.5 Rasterize a vector layer ------------------------------------------------</span></span>
<span id="cb113-197"><a href="annex-i-compendium-of-r-scripts.html#cb113-197" aria-hidden="true" tabindex="-1"></a><span class="co"># Use rasterize() function to convert v_proj to raster</span></span>
<span id="cb113-198"><a href="annex-i-compendium-of-r-scripts.html#cb113-198" aria-hidden="true" tabindex="-1"></a><span class="co"># Use r_proj as reference raster</span></span>
<span id="cb113-199"><a href="annex-i-compendium-of-r-scripts.html#cb113-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Use field Symbol to assign cell values, and plot the new map</span></span>
<span id="cb113-200"><a href="annex-i-compendium-of-r-scripts.html#cb113-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-201"><a href="annex-i-compendium-of-r-scripts.html#cb113-201" aria-hidden="true" tabindex="-1"></a>v_class <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(<span class="at">x =</span> v_proj, <span class="at">y =</span> r_proj, <span class="at">field =</span> <span class="st">&quot;Symbol&quot;</span> )</span>
<span id="cb113-202"><a href="annex-i-compendium-of-r-scripts.html#cb113-202" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(v_class)</span>
<span id="cb113-203"><a href="annex-i-compendium-of-r-scripts.html#cb113-203" aria-hidden="true" tabindex="-1"></a>v_class</span>
<span id="cb113-204"><a href="annex-i-compendium-of-r-scripts.html#cb113-204" aria-hidden="true" tabindex="-1"></a><span class="fu">activeCat</span>(v_class) <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb113-205"><a href="annex-i-compendium-of-r-scripts.html#cb113-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-206"><a href="annex-i-compendium-of-r-scripts.html#cb113-206" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.6 Extracting raster values using points -----------------------------------</span></span>
<span id="cb113-207"><a href="annex-i-compendium-of-r-scripts.html#cb113-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Covert dat_6 to spatial points using vect() function (check help of vect())</span></span>
<span id="cb113-208"><a href="annex-i-compendium-of-r-scripts.html#cb113-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the EPSG number is 6204</span></span>
<span id="cb113-209"><a href="annex-i-compendium-of-r-scripts.html#cb113-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the points as s</span></span>
<span id="cb113-210"><a href="annex-i-compendium-of-r-scripts.html#cb113-210" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot s and r_proj together in the same map (Argument add=TRUE)</span></span>
<span id="cb113-211"><a href="annex-i-compendium-of-r-scripts.html#cb113-211" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the values of the raster using extract() function (check the help)</span></span>
<span id="cb113-212"><a href="annex-i-compendium-of-r-scripts.html#cb113-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove the ID column of the extracted values</span></span>
<span id="cb113-213"><a href="annex-i-compendium-of-r-scripts.html#cb113-213" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the extracted data with s using cbind() function</span></span>
<span id="cb113-214"><a href="annex-i-compendium-of-r-scripts.html#cb113-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert s as a dataframe</span></span>
<span id="cb113-215"><a href="annex-i-compendium-of-r-scripts.html#cb113-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-216"><a href="annex-i-compendium-of-r-scripts.html#cb113-216" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">vect</span>(dat_6, <span class="at">geom=</span><span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="st">&quot;epsg:6204&quot;</span>)</span>
<span id="cb113-217"><a href="annex-i-compendium-of-r-scripts.html#cb113-217" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r_proj)</span>
<span id="cb113-218"><a href="annex-i-compendium-of-r-scripts.html#cb113-218" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(s, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb113-219"><a href="annex-i-compendium-of-r-scripts.html#cb113-219" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">extract</span>(r_proj,s, <span class="at">ID=</span><span class="cn">FALSE</span>)</span>
<span id="cb113-220"><a href="annex-i-compendium-of-r-scripts.html#cb113-220" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">cbind</span>(s,x)</span>
<span id="cb113-221"><a href="annex-i-compendium-of-r-scripts.html#cb113-221" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(s)</span>
<span id="cb113-222"><a href="annex-i-compendium-of-r-scripts.html#cb113-222" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb113-223"><a href="annex-i-compendium-of-r-scripts.html#cb113-223" aria-hidden="true" tabindex="-1"></a><span class="co">#GGally::ggscatmat(d)</span></span>
<span id="cb113-224"><a href="annex-i-compendium-of-r-scripts.html#cb113-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-225"><a href="annex-i-compendium-of-r-scripts.html#cb113-225" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.7 Zonal statistics using polygons and rasters -----------------------------</span></span>
<span id="cb113-226"><a href="annex-i-compendium-of-r-scripts.html#cb113-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the extract() func. to estimate the mean value of r_proj at each polygon</span></span>
<span id="cb113-227"><a href="annex-i-compendium-of-r-scripts.html#cb113-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the fun= argument (check the help)</span></span>
<span id="cb113-228"><a href="annex-i-compendium-of-r-scripts.html#cb113-228" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the cbind() func. to merge v_proj and the extracted values</span></span>
<span id="cb113-229"><a href="annex-i-compendium-of-r-scripts.html#cb113-229" aria-hidden="true" tabindex="-1"></a><span class="co"># convert v_proj to a dataframe</span></span>
<span id="cb113-230"><a href="annex-i-compendium-of-r-scripts.html#cb113-230" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a ggplot boxplot (geom_boxplot) with x=Symbol and y=grass </span></span>
<span id="cb113-231"><a href="annex-i-compendium-of-r-scripts.html#cb113-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-232"><a href="annex-i-compendium-of-r-scripts.html#cb113-232" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">extract</span>(r_proj, v_proj, <span class="at">fun =</span> mean, <span class="at">ID=</span><span class="cn">FALSE</span>)</span>
<span id="cb113-233"><a href="annex-i-compendium-of-r-scripts.html#cb113-233" aria-hidden="true" tabindex="-1"></a>v_proj <span class="ot">&lt;-</span> <span class="fu">cbind</span>(v_proj, x)</span>
<span id="cb113-234"><a href="annex-i-compendium-of-r-scripts.html#cb113-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-235"><a href="annex-i-compendium-of-r-scripts.html#cb113-235" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(v_proj)</span>
<span id="cb113-236"><a href="annex-i-compendium-of-r-scripts.html#cb113-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-237"><a href="annex-i-compendium-of-r-scripts.html#cb113-237" aria-hidden="true" tabindex="-1"></a>d <span class="sc">%&gt;%</span> </span>
<span id="cb113-238"><a href="annex-i-compendium-of-r-scripts.html#cb113-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span>Symbol, <span class="at">y =</span> grass, <span class="at">fill =</span> Symbol)) <span class="sc">+</span></span>
<span id="cb113-239"><a href="annex-i-compendium-of-r-scripts.html#cb113-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb113-240"><a href="annex-i-compendium-of-r-scripts.html#cb113-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Grass probability&quot;</span>)</span>
<span id="cb113-241"><a href="annex-i-compendium-of-r-scripts.html#cb113-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-242"><a href="annex-i-compendium-of-r-scripts.html#cb113-242" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.8 Bonus track: use zonal() function ---------------------------------------</span></span>
<span id="cb113-243"><a href="annex-i-compendium-of-r-scripts.html#cb113-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-244"><a href="annex-i-compendium-of-r-scripts.html#cb113-244" aria-hidden="true" tabindex="-1"></a><span class="fu">zonal</span>(r_proj, v_class, <span class="at">na.rm=</span>T)</span></code></pre></div>
</div>
<div id="script-2-data-preparation" class="section level2 unnumbered hasAnchor">
<h2>Script 2: Data preparation<a href="annex-i-compendium-of-r-scripts.html#script-2-data-preparation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="annex-i-compendium-of-r-scripts.html#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb114-2"><a href="annex-i-compendium-of-r-scripts.html#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Digital Soil Mapping</span></span>
<span id="cb114-3"><a href="annex-i-compendium-of-r-scripts.html#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Profile Data</span></span>
<span id="cb114-4"><a href="annex-i-compendium-of-r-scripts.html#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Cleaning and Processing</span></span>
<span id="cb114-5"><a href="annex-i-compendium-of-r-scripts.html#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb114-6"><a href="annex-i-compendium-of-r-scripts.html#cb114-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb114-7"><a href="annex-i-compendium-of-r-scripts.html#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Isabel.Luotto@fao.org</span></span>
<span id="cb114-8"><a href="annex-i-compendium-of-r-scripts.html#cb114-8" aria-hidden="true" tabindex="-1"></a><span class="co">#          Marcos.Angelini@fao.org</span></span>
<span id="cb114-9"><a href="annex-i-compendium-of-r-scripts.html#cb114-9" aria-hidden="true" tabindex="-1"></a><span class="co">#_______________________________________________________________________________</span></span>
<span id="cb114-10"><a href="annex-i-compendium-of-r-scripts.html#cb114-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-11"><a href="annex-i-compendium-of-r-scripts.html#cb114-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Empty environment and cache </span></span>
<span id="cb114-12"><a href="annex-i-compendium-of-r-scripts.html#cb114-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb114-13"><a href="annex-i-compendium-of-r-scripts.html#cb114-13" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb114-14"><a href="annex-i-compendium-of-r-scripts.html#cb114-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-15"><a href="annex-i-compendium-of-r-scripts.html#cb114-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script =======================================================</span></span>
<span id="cb114-16"><a href="annex-i-compendium-of-r-scripts.html#cb114-16" aria-hidden="true" tabindex="-1"></a><span class="co"># The goal of this script is to organise the soil data for mapping, including:</span></span>
<span id="cb114-17"><a href="annex-i-compendium-of-r-scripts.html#cb114-17" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb114-18"><a href="annex-i-compendium-of-r-scripts.html#cb114-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - User-defined variables </span></span>
<span id="cb114-19"><a href="annex-i-compendium-of-r-scripts.html#cb114-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - Set working directory and load necessary packages</span></span>
<span id="cb114-20"><a href="annex-i-compendium-of-r-scripts.html#cb114-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Import national data </span></span>
<span id="cb114-21"><a href="annex-i-compendium-of-r-scripts.html#cb114-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Select useful columns</span></span>
<span id="cb114-22"><a href="annex-i-compendium-of-r-scripts.html#cb114-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Quality check</span></span>
<span id="cb114-23"><a href="annex-i-compendium-of-r-scripts.html#cb114-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Estimate BD using pedotransfer function</span></span>
<span id="cb114-24"><a href="annex-i-compendium-of-r-scripts.html#cb114-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Harmonize soil layers</span></span>
<span id="cb114-25"><a href="annex-i-compendium-of-r-scripts.html#cb114-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Add chemical properties from additional dataset</span></span>
<span id="cb114-26"><a href="annex-i-compendium-of-r-scripts.html#cb114-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Plot and save results</span></span>
<span id="cb114-27"><a href="annex-i-compendium-of-r-scripts.html#cb114-27" aria-hidden="true" tabindex="-1"></a><span class="co">#_______________________________________________________________________________</span></span>
<span id="cb114-28"><a href="annex-i-compendium-of-r-scripts.html#cb114-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-29"><a href="annex-i-compendium-of-r-scripts.html#cb114-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - User-defined variables ===================================================</span></span>
<span id="cb114-30"><a href="annex-i-compendium-of-r-scripts.html#cb114-30" aria-hidden="true" tabindex="-1"></a>wd <span class="ot">&lt;-</span> <span class="st">&#39;C:/Users/luottoi/Documents/GitHub/GSNmap-TM/Digital-Soil-Mapping&#39;</span></span>
<span id="cb114-31"><a href="annex-i-compendium-of-r-scripts.html#cb114-31" aria-hidden="true" tabindex="-1"></a><span class="co">#wd &lt;- &quot;C:/GIT/GSNmap-TM/Digital-Soil-Mapping&quot;</span></span>
<span id="cb114-32"><a href="annex-i-compendium-of-r-scripts.html#cb114-32" aria-hidden="true" tabindex="-1"></a><span class="co">#wd &lt;- &#39;C:/Users/hp/Documents/GitHub/GSNmap-TM/Digital-Soil-Mapping&#39;</span></span>
<span id="cb114-33"><a href="annex-i-compendium-of-r-scripts.html#cb114-33" aria-hidden="true" tabindex="-1"></a><span class="co">#wd &lt;- &quot;/Users/luislado/Library/CloudStorage/Dropbox/GeoForsk/Clientes/FAO/GSNmap/Training Material/Digital-Soil-Mapping&quot;</span></span>
<span id="cb114-34"><a href="annex-i-compendium-of-r-scripts.html#cb114-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-35"><a href="annex-i-compendium-of-r-scripts.html#cb114-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - Set working directory and load necessary packages ========================</span></span>
<span id="cb114-36"><a href="annex-i-compendium-of-r-scripts.html#cb114-36" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(wd) <span class="co"># change the path accordingly</span></span>
<span id="cb114-37"><a href="annex-i-compendium-of-r-scripts.html#cb114-37" aria-hidden="true" tabindex="-1"></a><span class="co">#(setwd(dirname(rstudioapi::getActiveDocumentContext()$path)))</span></span>
<span id="cb114-38"><a href="annex-i-compendium-of-r-scripts.html#cb114-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-39"><a href="annex-i-compendium-of-r-scripts.html#cb114-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># for data management and reshaping</span></span>
<span id="cb114-40"><a href="annex-i-compendium-of-r-scripts.html#cb114-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl) <span class="co"># for importing excel files</span></span>
<span id="cb114-41"><a href="annex-i-compendium-of-r-scripts.html#cb114-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mapview) <span class="co"># for seeing the profiles in a map</span></span>
<span id="cb114-42"><a href="annex-i-compendium-of-r-scripts.html#cb114-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># to manage spatial data (shp vectors) </span></span>
<span id="cb114-43"><a href="annex-i-compendium-of-r-scripts.html#cb114-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(aqp) <span class="co"># for soil profile data</span></span>
<span id="cb114-44"><a href="annex-i-compendium-of-r-scripts.html#cb114-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mpspline2) <span class="co"># for horizon harmonization</span></span>
<span id="cb114-45"><a href="annex-i-compendium-of-r-scripts.html#cb114-45" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly) <span class="co"># interactive plots</span></span>
<span id="cb114-46"><a href="annex-i-compendium-of-r-scripts.html#cb114-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-47"><a href="annex-i-compendium-of-r-scripts.html#cb114-47" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Import national data =====================================================</span></span>
<span id="cb114-48"><a href="annex-i-compendium-of-r-scripts.html#cb114-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Save your national soil dataset in the data folder /01-Data as a .csv file or </span></span>
<span id="cb114-49"><a href="annex-i-compendium-of-r-scripts.html#cb114-49" aria-hidden="true" tabindex="-1"></a><span class="co"># as a .xlsx file</span></span>
<span id="cb114-50"><a href="annex-i-compendium-of-r-scripts.html#cb114-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-51"><a href="annex-i-compendium-of-r-scripts.html#cb114-51" aria-hidden="true" tabindex="-1"></a><span class="do">## 2.1 - for .xlsx files -------------------------------------------------------</span></span>
<span id="cb114-52"><a href="annex-i-compendium-of-r-scripts.html#cb114-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Import horizon data </span></span>
<span id="cb114-53"><a href="annex-i-compendium-of-r-scripts.html#cb114-53" aria-hidden="true" tabindex="-1"></a><span class="co"># hor &lt;- read_excel(&quot;01-Data/soil_data.xlsx&quot;, sheet = 2)</span></span>
<span id="cb114-54"><a href="annex-i-compendium-of-r-scripts.html#cb114-54" aria-hidden="true" tabindex="-1"></a><span class="co"># # Import site-level data</span></span>
<span id="cb114-55"><a href="annex-i-compendium-of-r-scripts.html#cb114-55" aria-hidden="true" tabindex="-1"></a><span class="co"># site &lt;- read_excel(&quot;01-Data/soil_data.xlsx&quot;, sheet = 1)</span></span>
<span id="cb114-56"><a href="annex-i-compendium-of-r-scripts.html#cb114-56" aria-hidden="true" tabindex="-1"></a><span class="co"># chem &lt;- read_excel(&quot;01-Data/soil_data.xlsx&quot;, sheet = 2)</span></span>
<span id="cb114-57"><a href="annex-i-compendium-of-r-scripts.html#cb114-57" aria-hidden="true" tabindex="-1"></a><span class="co"># phys &lt;- read_excel(&quot;01-Data/soil_data.xlsx&quot;, sheet = 3)</span></span>
<span id="cb114-58"><a href="annex-i-compendium-of-r-scripts.html#cb114-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-59"><a href="annex-i-compendium-of-r-scripts.html#cb114-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-60"><a href="annex-i-compendium-of-r-scripts.html#cb114-60" aria-hidden="true" tabindex="-1"></a><span class="do">## 2.2 - for .csv files --------------------------------------------------------</span></span>
<span id="cb114-61"><a href="annex-i-compendium-of-r-scripts.html#cb114-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Import horizon data </span></span>
<span id="cb114-62"><a href="annex-i-compendium-of-r-scripts.html#cb114-62" aria-hidden="true" tabindex="-1"></a>hor <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="at">file =</span> <span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb114-63"><a href="annex-i-compendium-of-r-scripts.html#cb114-63" aria-hidden="true" tabindex="-1"></a>chem <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="at">file =</span> <span class="st">&quot;01-Data/soil_chem_data030.csv&quot;</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb114-64"><a href="annex-i-compendium-of-r-scripts.html#cb114-64" aria-hidden="true" tabindex="-1"></a>phys <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="at">file =</span> <span class="st">&quot;01-Data/soil_phys_data030.csv&quot;</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb114-65"><a href="annex-i-compendium-of-r-scripts.html#cb114-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-66"><a href="annex-i-compendium-of-r-scripts.html#cb114-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-67"><a href="annex-i-compendium-of-r-scripts.html#cb114-67" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> <span class="fu">select</span>(hor, id_prof, x, y) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb114-68"><a href="annex-i-compendium-of-r-scripts.html#cb114-68" aria-hidden="true" tabindex="-1"></a>hor <span class="ot">&lt;-</span> <span class="fu">select</span>(hor, id_prof, id_hor, top<span class="sc">:</span>cec)</span>
<span id="cb114-69"><a href="annex-i-compendium-of-r-scripts.html#cb114-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-70"><a href="annex-i-compendium-of-r-scripts.html#cb114-70" aria-hidden="true" tabindex="-1"></a><span class="co"># change names of key columns</span></span>
<span id="cb114-71"><a href="annex-i-compendium-of-r-scripts.html#cb114-71" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(site)</span>
<span id="cb114-72"><a href="annex-i-compendium-of-r-scripts.html#cb114-72" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(site)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;ProfID&quot;</span></span>
<span id="cb114-73"><a href="annex-i-compendium-of-r-scripts.html#cb114-73" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(hor)</span>
<span id="cb114-74"><a href="annex-i-compendium-of-r-scripts.html#cb114-74" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(hor)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;ProfID&quot;</span></span>
<span id="cb114-75"><a href="annex-i-compendium-of-r-scripts.html#cb114-75" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(hor)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;HorID&quot;</span></span>
<span id="cb114-76"><a href="annex-i-compendium-of-r-scripts.html#cb114-76" aria-hidden="true" tabindex="-1"></a><span class="co"># scan the data</span></span>
<span id="cb114-77"><a href="annex-i-compendium-of-r-scripts.html#cb114-77" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(site)</span>
<span id="cb114-78"><a href="annex-i-compendium-of-r-scripts.html#cb114-78" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(hor)</span>
<span id="cb114-79"><a href="annex-i-compendium-of-r-scripts.html#cb114-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-80"><a href="annex-i-compendium-of-r-scripts.html#cb114-80" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - select useful columns ====================================================</span></span>
<span id="cb114-81"><a href="annex-i-compendium-of-r-scripts.html#cb114-81" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.1 - select AND RENAME columns --------------------------------------------------------</span></span>
<span id="cb114-82"><a href="annex-i-compendium-of-r-scripts.html#cb114-82" aria-hidden="true" tabindex="-1"></a>hor <span class="ot">&lt;-</span> <span class="fu">select</span>(hor, ProfID, HorID, top, bottom, <span class="at">ph=</span>ph_h2o, k, soc, bd, cec)</span>
<span id="cb114-83"><a href="annex-i-compendium-of-r-scripts.html#cb114-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-84"><a href="annex-i-compendium-of-r-scripts.html#cb114-84" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Quality check ============================================================</span></span>
<span id="cb114-85"><a href="annex-i-compendium-of-r-scripts.html#cb114-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-86"><a href="annex-i-compendium-of-r-scripts.html#cb114-86" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.1 - Check locations -------------------------------------------------------</span></span>
<span id="cb114-87"><a href="annex-i-compendium-of-r-scripts.html#cb114-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Macedonian State Coordinate System EPSG:6204  </span></span>
<span id="cb114-88"><a href="annex-i-compendium-of-r-scripts.html#cb114-88" aria-hidden="true" tabindex="-1"></a><span class="co"># https://epsg.io/6204 </span></span>
<span id="cb114-89"><a href="annex-i-compendium-of-r-scripts.html#cb114-89" aria-hidden="true" tabindex="-1"></a>site <span class="sc">%&gt;%</span> </span>
<span id="cb114-90"><a href="annex-i-compendium-of-r-scripts.html#cb114-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span> <span class="co"># convert to spatial object</span></span>
<span id="cb114-91"><a href="annex-i-compendium-of-r-scripts.html#cb114-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapview</span>(<span class="at">zcol =</span> <span class="st">&quot;ProfID&quot;</span>, <span class="at">cex =</span> <span class="dv">3</span>, <span class="at">lwd =</span> <span class="fl">0.1</span>) <span class="co"># visualise in an interactive map</span></span>
<span id="cb114-92"><a href="annex-i-compendium-of-r-scripts.html#cb114-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-93"><a href="annex-i-compendium-of-r-scripts.html#cb114-93" aria-hidden="true" tabindex="-1"></a>site_sub <span class="ot">&lt;-</span> site[site<span class="sc">$</span>ProfID<span class="sc">==</span><span class="st">&#39;2823&#39;</span>,] </span>
<span id="cb114-94"><a href="annex-i-compendium-of-r-scripts.html#cb114-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-95"><a href="annex-i-compendium-of-r-scripts.html#cb114-95" aria-hidden="true" tabindex="-1"></a>site_sub <span class="sc">%&gt;%</span> </span>
<span id="cb114-96"><a href="annex-i-compendium-of-r-scripts.html#cb114-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span> <span class="co"># convert to spatial object</span></span>
<span id="cb114-97"><a href="annex-i-compendium-of-r-scripts.html#cb114-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapview</span>(<span class="at">zcol =</span> <span class="st">&quot;ProfID&quot;</span>, <span class="at">cex =</span> <span class="dv">3</span>, <span class="at">lwd =</span> <span class="fl">0.1</span>) <span class="co"># visualise in an interactive map</span></span>
<span id="cb114-98"><a href="annex-i-compendium-of-r-scripts.html#cb114-98" aria-hidden="true" tabindex="-1"></a><span class="co"># profile 2823 is wrongly located, so let&#39;s remove it</span></span>
<span id="cb114-99"><a href="annex-i-compendium-of-r-scripts.html#cb114-99" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> <span class="fu">filter</span>(site, ProfID <span class="sc">!=</span> <span class="dv">2823</span>)</span>
<span id="cb114-100"><a href="annex-i-compendium-of-r-scripts.html#cb114-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-101"><a href="annex-i-compendium-of-r-scripts.html#cb114-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-102"><a href="annex-i-compendium-of-r-scripts.html#cb114-102" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.2 - Convert data into a Soil Profile Collection ---------------------------</span></span>
<span id="cb114-103"><a href="annex-i-compendium-of-r-scripts.html#cb114-103" aria-hidden="true" tabindex="-1"></a>aqp<span class="sc">::</span><span class="fu">depths</span>(hor) <span class="ot">&lt;-</span> ProfID <span class="sc">~</span> top <span class="sc">+</span> bottom </span>
<span id="cb114-104"><a href="annex-i-compendium-of-r-scripts.html#cb114-104" aria-hidden="true" tabindex="-1"></a>hor<span class="sc">@</span>site<span class="sc">$</span>ProfID <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(hor<span class="sc">@</span>site<span class="sc">$</span>ProfID) </span>
<span id="cb114-105"><a href="annex-i-compendium-of-r-scripts.html#cb114-105" aria-hidden="true" tabindex="-1"></a><span class="fu">site</span>(hor) <span class="ot">&lt;-</span> <span class="fu">left_join</span>(<span class="fu">site</span>(hor), site)</span>
<span id="cb114-106"><a href="annex-i-compendium-of-r-scripts.html#cb114-106" aria-hidden="true" tabindex="-1"></a>profiles <span class="ot">&lt;-</span> hor</span>
<span id="cb114-107"><a href="annex-i-compendium-of-r-scripts.html#cb114-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-108"><a href="annex-i-compendium-of-r-scripts.html#cb114-108" aria-hidden="true" tabindex="-1"></a>profiles</span>
<span id="cb114-109"><a href="annex-i-compendium-of-r-scripts.html#cb114-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-110"><a href="annex-i-compendium-of-r-scripts.html#cb114-110" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.3 - plot first 20 profiles using pH as color ------------------------------</span></span>
<span id="cb114-111"><a href="annex-i-compendium-of-r-scripts.html#cb114-111" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSPC</span>(<span class="at">x =</span> profiles[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>], <span class="at">name =</span> <span class="st">&quot;pH&quot;</span>, <span class="at">color =</span> <span class="st">&quot;ph&quot;</span>,</span>
<span id="cb114-112"><a href="annex-i-compendium-of-r-scripts.html#cb114-112" aria-hidden="true" tabindex="-1"></a>        <span class="at">name.style =</span> <span class="st">&quot;center-center&quot;</span>)</span>
<span id="cb114-113"><a href="annex-i-compendium-of-r-scripts.html#cb114-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-114"><a href="annex-i-compendium-of-r-scripts.html#cb114-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-115"><a href="annex-i-compendium-of-r-scripts.html#cb114-115" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.4 - check data integrity --------------------------------------------------</span></span>
<span id="cb114-116"><a href="annex-i-compendium-of-r-scripts.html#cb114-116" aria-hidden="true" tabindex="-1"></a><span class="co"># A valid profile is TRUE if all of the following criteria are false:</span></span>
<span id="cb114-117"><a href="annex-i-compendium-of-r-scripts.html#cb114-117" aria-hidden="true" tabindex="-1"></a><span class="co">#    + depthLogic : boolean, errors related to depth logic</span></span>
<span id="cb114-118"><a href="annex-i-compendium-of-r-scripts.html#cb114-118" aria-hidden="true" tabindex="-1"></a><span class="co">#    + sameDepth : boolean, errors related to same top/bottom depths</span></span>
<span id="cb114-119"><a href="annex-i-compendium-of-r-scripts.html#cb114-119" aria-hidden="true" tabindex="-1"></a><span class="co">#    + missingDepth : boolean, NA in top / bottom depths</span></span>
<span id="cb114-120"><a href="annex-i-compendium-of-r-scripts.html#cb114-120" aria-hidden="true" tabindex="-1"></a><span class="co">#    + overlapOrGap : boolean, gaps or overlap in adjacent horizons</span></span>
<span id="cb114-121"><a href="annex-i-compendium-of-r-scripts.html#cb114-121" aria-hidden="true" tabindex="-1"></a>aqp<span class="sc">::</span><span class="fu">checkHzDepthLogic</span>(profiles)</span>
<span id="cb114-122"><a href="annex-i-compendium-of-r-scripts.html#cb114-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-123"><a href="annex-i-compendium-of-r-scripts.html#cb114-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify non-valid profiles </span></span>
<span id="cb114-124"><a href="annex-i-compendium-of-r-scripts.html#cb114-124" aria-hidden="true" tabindex="-1"></a>dl <span class="ot">&lt;-</span> <span class="fu">checkHzDepthLogic</span>(profiles)</span>
<span id="cb114-125"><a href="annex-i-compendium-of-r-scripts.html#cb114-125" aria-hidden="true" tabindex="-1"></a>dl[dl<span class="sc">$</span>depthLogic<span class="sc">==</span>T <span class="sc">|</span> dl<span class="sc">$</span>sameDepth<span class="sc">==</span>T <span class="sc">|</span> dl<span class="sc">$</span>missingDepth<span class="sc">==</span>T <span class="sc">|</span> dl<span class="sc">$</span>overlapOrGap<span class="sc">==</span>T,<span class="st">&quot;ProfID&quot;</span>]</span>
<span id="cb114-126"><a href="annex-i-compendium-of-r-scripts.html#cb114-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-127"><a href="annex-i-compendium-of-r-scripts.html#cb114-127" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize some of these profiles by the pid</span></span>
<span id="cb114-128"><a href="annex-i-compendium-of-r-scripts.html#cb114-128" aria-hidden="true" tabindex="-1"></a><span class="fu">subset</span>(profiles, <span class="fu">grepl</span>(<span class="dv">6566</span>, ProfID, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb114-129"><a href="annex-i-compendium-of-r-scripts.html#cb114-129" aria-hidden="true" tabindex="-1"></a><span class="fu">subset</span>(profiles, <span class="fu">grepl</span>(<span class="dv">7410</span> , ProfID, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb114-130"><a href="annex-i-compendium-of-r-scripts.html#cb114-130" aria-hidden="true" tabindex="-1"></a><span class="fu">subset</span>(profiles, <span class="fu">grepl</span>(<span class="dv">8002</span>, ProfID, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb114-131"><a href="annex-i-compendium-of-r-scripts.html#cb114-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-132"><a href="annex-i-compendium-of-r-scripts.html#cb114-132" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.5 - keep only valid profiles ----------------------------------------------</span></span>
<span id="cb114-133"><a href="annex-i-compendium-of-r-scripts.html#cb114-133" aria-hidden="true" tabindex="-1"></a>clean_prof <span class="ot">&lt;-</span> <span class="fu">HzDepthLogicSubset</span>(profiles)</span>
<span id="cb114-134"><a href="annex-i-compendium-of-r-scripts.html#cb114-134" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span>(clean_prof)<span class="sc">$</span>removed.profiles</span>
<span id="cb114-135"><a href="annex-i-compendium-of-r-scripts.html#cb114-135" aria-hidden="true" tabindex="-1"></a><span class="co"># write_rds(clean_prof, &quot;01-Data/soilProfileCollection.rds&quot;)</span></span>
<span id="cb114-136"><a href="annex-i-compendium-of-r-scripts.html#cb114-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-137"><a href="annex-i-compendium-of-r-scripts.html#cb114-137" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.6 convert soilProfileCollection to a table --------------------------------</span></span>
<span id="cb114-138"><a href="annex-i-compendium-of-r-scripts.html#cb114-138" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">left_join</span>(clean_prof<span class="sc">@</span>site, clean_prof<span class="sc">@</span>horizons)</span>
<span id="cb114-139"><a href="annex-i-compendium-of-r-scripts.html#cb114-139" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">select</span>(dat, ProfID, HorID, x, y, top, bottom, ph<span class="sc">:</span>cec )</span>
<span id="cb114-140"><a href="annex-i-compendium-of-r-scripts.html#cb114-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-141"><a href="annex-i-compendium-of-r-scripts.html#cb114-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-142"><a href="annex-i-compendium-of-r-scripts.html#cb114-142" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Estimate BD using pedotransfer functions =================================</span></span>
<span id="cb114-143"><a href="annex-i-compendium-of-r-scripts.html#cb114-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-144"><a href="annex-i-compendium-of-r-scripts.html#cb114-144" aria-hidden="true" tabindex="-1"></a><span class="co"># create the function with all PTF</span></span>
<span id="cb114-145"><a href="annex-i-compendium-of-r-scripts.html#cb114-145" aria-hidden="true" tabindex="-1"></a>method_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Saini1996&quot;</span>, <span class="st">&quot;Drew1973&quot;</span>, <span class="st">&quot;Jeffrey1979&quot;</span>, <span class="st">&quot;Grigal1989&quot;</span>, </span>
<span id="cb114-146"><a href="annex-i-compendium-of-r-scripts.html#cb114-146" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;Adams1973&quot;</span>, <span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span>) </span>
<span id="cb114-147"><a href="annex-i-compendium-of-r-scripts.html#cb114-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-148"><a href="annex-i-compendium-of-r-scripts.html#cb114-148" aria-hidden="true" tabindex="-1"></a>estimateBD <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">SOC=</span><span class="cn">NULL</span>, <span class="at">method=</span><span class="cn">NULL</span>) {</span>
<span id="cb114-149"><a href="annex-i-compendium-of-r-scripts.html#cb114-149" aria-hidden="true" tabindex="-1"></a>  OM <span class="ot">&lt;-</span> SOC <span class="sc">*</span> <span class="fl">1.724</span></span>
<span id="cb114-150"><a href="annex-i-compendium-of-r-scripts.html#cb114-150" aria-hidden="true" tabindex="-1"></a>  BD <span class="ot">&lt;-</span> <span class="cf">switch</span>(method,</span>
<span id="cb114-151"><a href="annex-i-compendium-of-r-scripts.html#cb114-151" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;Saini1996&quot;</span> <span class="ot">=</span> <span class="fl">1.62</span> <span class="sc">-</span> <span class="fl">0.06</span> <span class="sc">*</span> OM,</span>
<span id="cb114-152"><a href="annex-i-compendium-of-r-scripts.html#cb114-152" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;Drew1973&quot;</span> <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="fl">0.6268</span> <span class="sc">+</span> <span class="fl">0.0361</span> <span class="sc">*</span> OM),</span>
<span id="cb114-153"><a href="annex-i-compendium-of-r-scripts.html#cb114-153" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;Jeffrey1979&quot;</span> <span class="ot">=</span> <span class="fl">1.482</span> <span class="sc">-</span> <span class="fl">0.6786</span> <span class="sc">*</span> (<span class="fu">log</span>(OM)),</span>
<span id="cb114-154"><a href="annex-i-compendium-of-r-scripts.html#cb114-154" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;Grigal1989&quot;</span> <span class="ot">=</span> <span class="fl">0.669</span> <span class="sc">+</span> <span class="fl">0.941</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="dv">1</span>)<span class="sc">^</span>(<span class="sc">-</span><span class="fl">0.06</span> <span class="sc">*</span> OM),</span>
<span id="cb114-155"><a href="annex-i-compendium-of-r-scripts.html#cb114-155" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;Adams1973&quot;</span> <span class="ot">=</span> <span class="dv">100</span> <span class="sc">/</span> (OM <span class="sc">/</span> <span class="fl">0.244</span> <span class="sc">+</span> (<span class="dv">100</span> <span class="sc">-</span> OM) <span class="sc">/</span> <span class="fl">2.65</span>),</span>
<span id="cb114-156"><a href="annex-i-compendium-of-r-scripts.html#cb114-156" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span> <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="fl">0.564</span> <span class="sc">+</span> <span class="fl">0.0556</span> <span class="sc">*</span> OM),</span>
<span id="cb114-157"><a href="annex-i-compendium-of-r-scripts.html#cb114-157" aria-hidden="true" tabindex="-1"></a>               <span class="fu">stop</span>(<span class="st">&quot;Invalid method specified.&quot;</span>)</span>
<span id="cb114-158"><a href="annex-i-compendium-of-r-scripts.html#cb114-158" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb114-159"><a href="annex-i-compendium-of-r-scripts.html#cb114-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(BD)</span>
<span id="cb114-160"><a href="annex-i-compendium-of-r-scripts.html#cb114-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb114-161"><a href="annex-i-compendium-of-r-scripts.html#cb114-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-162"><a href="annex-i-compendium-of-r-scripts.html#cb114-162" aria-hidden="true" tabindex="-1"></a><span class="co"># 5.1 - Select a pedotransfer function ----------------------------------------</span></span>
<span id="cb114-163"><a href="annex-i-compendium-of-r-scripts.html#cb114-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-164"><a href="annex-i-compendium-of-r-scripts.html#cb114-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-165"><a href="annex-i-compendium-of-r-scripts.html#cb114-165" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a test dataset with BD and SOC data</span></span>
<span id="cb114-166"><a href="annex-i-compendium-of-r-scripts.html#cb114-166" aria-hidden="true" tabindex="-1"></a>BD_test <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">SOC =</span> dat<span class="sc">$</span>soc, <span class="at">BD_observed =</span> dat<span class="sc">$</span>bd)</span>
<span id="cb114-167"><a href="annex-i-compendium-of-r-scripts.html#cb114-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-168"><a href="annex-i-compendium-of-r-scripts.html#cb114-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove missing values</span></span>
<span id="cb114-169"><a href="annex-i-compendium-of-r-scripts.html#cb114-169" aria-hidden="true" tabindex="-1"></a>BD_test <span class="ot">&lt;-</span> BD_test[<span class="fu">complete.cases</span>(BD_test),]</span>
<span id="cb114-170"><a href="annex-i-compendium-of-r-scripts.html#cb114-170" aria-hidden="true" tabindex="-1"></a>BD_test <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(BD_test) </span>
<span id="cb114-171"><a href="annex-i-compendium-of-r-scripts.html#cb114-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-172"><a href="annex-i-compendium-of-r-scripts.html#cb114-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-173"><a href="annex-i-compendium-of-r-scripts.html#cb114-173" aria-hidden="true" tabindex="-1"></a><span class="co"># 5.2 - Estimate BLD for a subset using the pedotransfer functions ------------</span></span>
<span id="cb114-174"><a href="annex-i-compendium-of-r-scripts.html#cb114-174" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> method_names) {</span>
<span id="cb114-175"><a href="annex-i-compendium-of-r-scripts.html#cb114-175" aria-hidden="true" tabindex="-1"></a>  BD_test[[i]] <span class="ot">&lt;-</span> <span class="fu">estimateBD</span>(BD_test<span class="sc">$</span>SOC, <span class="at">method =</span> i)</span>
<span id="cb114-176"><a href="annex-i-compendium-of-r-scripts.html#cb114-176" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb114-177"><a href="annex-i-compendium-of-r-scripts.html#cb114-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-178"><a href="annex-i-compendium-of-r-scripts.html#cb114-178" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the resulting data frame</span></span>
<span id="cb114-179"><a href="annex-i-compendium-of-r-scripts.html#cb114-179" aria-hidden="true" tabindex="-1"></a>BD_test</span>
<span id="cb114-180"><a href="annex-i-compendium-of-r-scripts.html#cb114-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-181"><a href="annex-i-compendium-of-r-scripts.html#cb114-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-182"><a href="annex-i-compendium-of-r-scripts.html#cb114-182" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.3 Compare results ---------------------------------------------------------</span></span>
<span id="cb114-183"><a href="annex-i-compendium-of-r-scripts.html#cb114-183" aria-hidden="true" tabindex="-1"></a><span class="co"># Observed values:</span></span>
<span id="cb114-184"><a href="annex-i-compendium-of-r-scripts.html#cb114-184" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(BD_test)</span>
<span id="cb114-185"><a href="annex-i-compendium-of-r-scripts.html#cb114-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-186"><a href="annex-i-compendium-of-r-scripts.html#cb114-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare data distributions for observed and predicted BLD</span></span>
<span id="cb114-187"><a href="annex-i-compendium-of-r-scripts.html#cb114-187" aria-hidden="true" tabindex="-1"></a>plot.bd <span class="ot">&lt;-</span> BD_test <span class="sc">%&gt;%</span></span>
<span id="cb114-188"><a href="annex-i-compendium-of-r-scripts.html#cb114-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>SOC) <span class="sc">%&gt;%</span> </span>
<span id="cb114-189"><a href="annex-i-compendium-of-r-scripts.html#cb114-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">&quot;BD_observed&quot;</span>, <span class="st">&quot;Saini1996&quot;</span>, <span class="st">&quot;Drew1973&quot;</span>, <span class="st">&quot;Jeffrey1979&quot;</span>,</span>
<span id="cb114-190"><a href="annex-i-compendium-of-r-scripts.html#cb114-190" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;Grigal1989&quot;</span>, <span class="st">&quot;Adams1973&quot;</span>, <span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span>), </span>
<span id="cb114-191"><a href="annex-i-compendium-of-r-scripts.html#cb114-191" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">&quot;Method&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;BD&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb114-192"><a href="annex-i-compendium-of-r-scripts.html#cb114-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> BD, <span class="at">color =</span> Method)) <span class="sc">+</span> </span>
<span id="cb114-193"><a href="annex-i-compendium-of-r-scripts.html#cb114-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span>
<span id="cb114-194"><a href="annex-i-compendium-of-r-scripts.html#cb114-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-195"><a href="annex-i-compendium-of-r-scripts.html#cb114-195" aria-hidden="true" tabindex="-1"></a>plot.bd</span>
<span id="cb114-196"><a href="annex-i-compendium-of-r-scripts.html#cb114-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-197"><a href="annex-i-compendium-of-r-scripts.html#cb114-197" aria-hidden="true" tabindex="-1"></a><span class="co"># Dymanic plot with plotly </span></span>
<span id="cb114-198"><a href="annex-i-compendium-of-r-scripts.html#cb114-198" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(plot.bd)</span>
<span id="cb114-199"><a href="annex-i-compendium-of-r-scripts.html#cb114-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-200"><a href="annex-i-compendium-of-r-scripts.html#cb114-200" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(plot.bd) <span class="sc">%&gt;%</span></span>
<span id="cb114-201"><a href="annex-i-compendium-of-r-scripts.html#cb114-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layout</span>(<span class="at">hovermode =</span> <span class="st">&quot;x&quot;</span>)</span>
<span id="cb114-202"><a href="annex-i-compendium-of-r-scripts.html#cb114-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-203"><a href="annex-i-compendium-of-r-scripts.html#cb114-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the Selected function again</span></span>
<span id="cb114-204"><a href="annex-i-compendium-of-r-scripts.html#cb114-204" aria-hidden="true" tabindex="-1"></a>BD_test <span class="sc">%&gt;%</span> </span>
<span id="cb114-205"><a href="annex-i-compendium-of-r-scripts.html#cb114-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>SOC) <span class="sc">%&gt;%</span> </span>
<span id="cb114-206"><a href="annex-i-compendium-of-r-scripts.html#cb114-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">&quot;BD_observed&quot;</span>, <span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span>), </span>
<span id="cb114-207"><a href="annex-i-compendium-of-r-scripts.html#cb114-207" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">&quot;Method&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;BD&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb114-208"><a href="annex-i-compendium-of-r-scripts.html#cb114-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> BD, <span class="at">color =</span> Method)) <span class="sc">+</span> </span>
<span id="cb114-209"><a href="annex-i-compendium-of-r-scripts.html#cb114-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span> <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">2.5</span>))</span>
<span id="cb114-210"><a href="annex-i-compendium-of-r-scripts.html#cb114-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-211"><a href="annex-i-compendium-of-r-scripts.html#cb114-211" aria-hidden="true" tabindex="-1"></a><span class="co"># Same dynamic plot </span></span>
<span id="cb114-212"><a href="annex-i-compendium-of-r-scripts.html#cb114-212" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(BD_test <span class="sc">%&gt;%</span> </span>
<span id="cb114-213"><a href="annex-i-compendium-of-r-scripts.html#cb114-213" aria-hidden="true" tabindex="-1"></a>           <span class="fu">select</span>(<span class="sc">-</span>SOC) <span class="sc">%&gt;%</span> </span>
<span id="cb114-214"><a href="annex-i-compendium-of-r-scripts.html#cb114-214" aria-hidden="true" tabindex="-1"></a>           <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">&quot;BD_observed&quot;</span>, <span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span>), </span>
<span id="cb114-215"><a href="annex-i-compendium-of-r-scripts.html#cb114-215" aria-hidden="true" tabindex="-1"></a>                        <span class="at">names_to =</span> <span class="st">&quot;Method&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;BD&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb114-216"><a href="annex-i-compendium-of-r-scripts.html#cb114-216" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> BD, <span class="at">color =</span> Method)) <span class="sc">+</span> </span>
<span id="cb114-217"><a href="annex-i-compendium-of-r-scripts.html#cb114-217" aria-hidden="true" tabindex="-1"></a>           <span class="fu">geom_density</span>() <span class="sc">+</span> <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">2.5</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb114-218"><a href="annex-i-compendium-of-r-scripts.html#cb114-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layout</span>(<span class="at">hovermode =</span> <span class="st">&quot;x&quot;</span>)</span>
<span id="cb114-219"><a href="annex-i-compendium-of-r-scripts.html#cb114-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-220"><a href="annex-i-compendium-of-r-scripts.html#cb114-220" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.4 Estimate BD for the missing horizons ------------------------------------</span></span>
<span id="cb114-221"><a href="annex-i-compendium-of-r-scripts.html#cb114-221" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>bd[<span class="fu">is.na</span>(dat<span class="sc">$</span>bd)] <span class="ot">&lt;-</span></span>
<span id="cb114-222"><a href="annex-i-compendium-of-r-scripts.html#cb114-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">estimateBD</span>(dat[<span class="fu">is.na</span>(dat<span class="sc">$</span>bd),]<span class="sc">$</span>soc, <span class="at">method=</span><span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span>)</span>
<span id="cb114-223"><a href="annex-i-compendium-of-r-scripts.html#cb114-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-224"><a href="annex-i-compendium-of-r-scripts.html#cb114-224" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore the results</span></span>
<span id="cb114-225"><a href="annex-i-compendium-of-r-scripts.html#cb114-225" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>bd)</span>
<span id="cb114-226"><a href="annex-i-compendium-of-r-scripts.html#cb114-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-227"><a href="annex-i-compendium-of-r-scripts.html#cb114-227" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> BD_test <span class="sc">%&gt;%</span> </span>
<span id="cb114-228"><a href="annex-i-compendium-of-r-scripts.html#cb114-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>SOC) <span class="sc">%&gt;%</span> </span>
<span id="cb114-229"><a href="annex-i-compendium-of-r-scripts.html#cb114-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">&quot;BD_observed&quot;</span>), </span>
<span id="cb114-230"><a href="annex-i-compendium-of-r-scripts.html#cb114-230" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">&quot;Method&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;BD&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb114-231"><a href="annex-i-compendium-of-r-scripts.html#cb114-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> BD, <span class="at">color =</span> Method)) <span class="sc">+</span> </span>
<span id="cb114-232"><a href="annex-i-compendium-of-r-scripts.html#cb114-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb114-233"><a href="annex-i-compendium-of-r-scripts.html#cb114-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">2.5</span>))</span>
<span id="cb114-234"><a href="annex-i-compendium-of-r-scripts.html#cb114-234" aria-hidden="true" tabindex="-1"></a>g <span class="sc">+</span> <span class="fu">geom_density</span>(<span class="at">data =</span> dat, <span class="fu">aes</span>(<span class="at">x=</span>bd, <span class="at">color =</span> <span class="st">&quot;Predicted +</span><span class="sc">\n</span><span class="st"> observed&quot;</span>))</span>
<span id="cb114-235"><a href="annex-i-compendium-of-r-scripts.html#cb114-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-236"><a href="annex-i-compendium-of-r-scripts.html#cb114-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-237"><a href="annex-i-compendium-of-r-scripts.html#cb114-237" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.5 - Explore outliers ------------------------------------------------------</span></span>
<span id="cb114-238"><a href="annex-i-compendium-of-r-scripts.html#cb114-238" aria-hidden="true" tabindex="-1"></a><span class="co"># Outliers should be carefully explored and compared with literature values.</span></span>
<span id="cb114-239"><a href="annex-i-compendium-of-r-scripts.html#cb114-239" aria-hidden="true" tabindex="-1"></a><span class="co"># Only if it is clear that outliers represent impossible or highly unlikely </span></span>
<span id="cb114-240"><a href="annex-i-compendium-of-r-scripts.html#cb114-240" aria-hidden="true" tabindex="-1"></a><span class="co"># values, they should be removed as errors.</span></span>
<span id="cb114-241"><a href="annex-i-compendium-of-r-scripts.html#cb114-241" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb114-242"><a href="annex-i-compendium-of-r-scripts.html#cb114-242" aria-hidden="true" tabindex="-1"></a><span class="co"># Carbon content higher than 15% is only typical for organic soil (histosols)</span></span>
<span id="cb114-243"><a href="annex-i-compendium-of-r-scripts.html#cb114-243" aria-hidden="true" tabindex="-1"></a><span class="co"># We will remove all atypically high SOC as outliers</span></span>
<span id="cb114-244"><a href="annex-i-compendium-of-r-scripts.html#cb114-244" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>soc)</span>
<span id="cb114-245"><a href="annex-i-compendium-of-r-scripts.html#cb114-245" aria-hidden="true" tabindex="-1"></a><span class="fu">na.omit</span>(dat<span class="sc">$</span>ProfID[dat<span class="sc">$</span>soc <span class="sc">&gt;</span> <span class="dv">10</span>])</span>
<span id="cb114-246"><a href="annex-i-compendium-of-r-scripts.html#cb114-246" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>ProfID[dat<span class="sc">$</span>soc <span class="sc">&gt;</span> <span class="dv">10</span>][<span class="sc">!</span><span class="fu">is.na</span>(dat<span class="sc">$</span>ProfID[dat<span class="sc">$</span>soc <span class="sc">&gt;</span> <span class="dv">10</span>])] </span>
<span id="cb114-247"><a href="annex-i-compendium-of-r-scripts.html#cb114-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-248"><a href="annex-i-compendium-of-r-scripts.html#cb114-248" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat[dat<span class="sc">$</span>ProfID <span class="sc">!=</span> <span class="dv">6915</span>,]</span>
<span id="cb114-249"><a href="annex-i-compendium-of-r-scripts.html#cb114-249" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat[dat<span class="sc">$</span>ProfID <span class="sc">!=</span> <span class="dv">7726</span>,]</span>
<span id="cb114-250"><a href="annex-i-compendium-of-r-scripts.html#cb114-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-251"><a href="annex-i-compendium-of-r-scripts.html#cb114-251" aria-hidden="true" tabindex="-1"></a>dat<span class="ot">&lt;-</span> dat[<span class="sc">!</span>(dat<span class="sc">$</span>ProfID <span class="sc">%in%</span> dat<span class="sc">$</span>ProfID[dat<span class="sc">$</span>soc <span class="sc">&gt;</span> <span class="dv">10</span>][<span class="sc">!</span><span class="fu">is.na</span>(dat<span class="sc">$</span>ProfID[dat<span class="sc">$</span>soc <span class="sc">&gt;</span> <span class="dv">10</span>])]),]</span>
<span id="cb114-252"><a href="annex-i-compendium-of-r-scripts.html#cb114-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-253"><a href="annex-i-compendium-of-r-scripts.html#cb114-253" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore bulk density data, identify outliers</span></span>
<span id="cb114-254"><a href="annex-i-compendium-of-r-scripts.html#cb114-254" aria-hidden="true" tabindex="-1"></a><span class="co"># remove layers with Bulk Density &lt; 1 g/cm^3</span></span>
<span id="cb114-255"><a href="annex-i-compendium-of-r-scripts.html#cb114-255" aria-hidden="true" tabindex="-1"></a>low_bd_profiles <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(dat<span class="sc">$</span>ProfID[dat<span class="sc">$</span>bd<span class="sc">&lt;</span><span class="dv">1</span>])</span>
<span id="cb114-256"><a href="annex-i-compendium-of-r-scripts.html#cb114-256" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat[<span class="sc">!</span>(dat<span class="sc">$</span>ProfID <span class="sc">%in%</span> low_bd_profiles),]</span>
<span id="cb114-257"><a href="annex-i-compendium-of-r-scripts.html#cb114-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-258"><a href="annex-i-compendium-of-r-scripts.html#cb114-258" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore data, identify outliers</span></span>
<span id="cb114-259"><a href="annex-i-compendium-of-r-scripts.html#cb114-259" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(dat, <span class="at">cols =</span> ph<span class="sc">:</span>cec, <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>,</span>
<span id="cb114-260"><a href="annex-i-compendium-of-r-scripts.html#cb114-260" aria-hidden="true" tabindex="-1"></a>                  <span class="at">names_to =</span> <span class="st">&quot;soil_property&quot;</span>)</span>
<span id="cb114-261"><a href="annex-i-compendium-of-r-scripts.html#cb114-261" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(x)</span>
<span id="cb114-262"><a href="annex-i-compendium-of-r-scripts.html#cb114-262" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(x, <span class="fu">aes</span>(<span class="at">x =</span> soil_property, <span class="at">y =</span> value, <span class="at">fill =</span> soil_property)) <span class="sc">+</span></span>
<span id="cb114-263"><a href="annex-i-compendium-of-r-scripts.html#cb114-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb114-264"><a href="annex-i-compendium-of-r-scripts.html#cb114-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>soil_property, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>)</span>
<span id="cb114-265"><a href="annex-i-compendium-of-r-scripts.html#cb114-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-266"><a href="annex-i-compendium-of-r-scripts.html#cb114-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-267"><a href="annex-i-compendium-of-r-scripts.html#cb114-267" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Harmonize soil layers ====================================================</span></span>
<span id="cb114-268"><a href="annex-i-compendium-of-r-scripts.html#cb114-268" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;03-Scripts/.spline_functions.R&quot;</span>) </span>
<span id="cb114-269"><a href="annex-i-compendium-of-r-scripts.html#cb114-269" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.1 - Set target soil properties and depths ---------------------------------</span></span>
<span id="cb114-270"><a href="annex-i-compendium-of-r-scripts.html#cb114-270" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(dat)</span>
<span id="cb114-271"><a href="annex-i-compendium-of-r-scripts.html#cb114-271" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">select</span>(dat, ProfID, HorID, x, y, top, bottom, ph, k, soc, bd, cec)</span>
<span id="cb114-272"><a href="annex-i-compendium-of-r-scripts.html#cb114-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-273"><a href="annex-i-compendium-of-r-scripts.html#cb114-273" aria-hidden="true" tabindex="-1"></a>target <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ph&quot;</span>, <span class="st">&quot;k&quot;</span>, <span class="st">&quot;soc&quot;</span>,  <span class="st">&quot;bd&quot;</span>, <span class="st">&quot;cec&quot;</span>)</span>
<span id="cb114-274"><a href="annex-i-compendium-of-r-scripts.html#cb114-274" aria-hidden="true" tabindex="-1"></a>depths <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">30</span>)</span>
<span id="cb114-275"><a href="annex-i-compendium-of-r-scripts.html#cb114-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-276"><a href="annex-i-compendium-of-r-scripts.html#cb114-276" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.2 - Create standard layers ------------------------------------------------</span></span>
<span id="cb114-277"><a href="annex-i-compendium-of-r-scripts.html#cb114-277" aria-hidden="true" tabindex="-1"></a>splines <span class="ot">&lt;-</span> <span class="fu">apply_mpspline_all</span>(<span class="at">df =</span> dat, <span class="at">properties =</span> target, <span class="at">depth_range =</span> depths)</span>
<span id="cb114-278"><a href="annex-i-compendium-of-r-scripts.html#cb114-278" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(splines)</span>
<span id="cb114-279"><a href="annex-i-compendium-of-r-scripts.html#cb114-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-280"><a href="annex-i-compendium-of-r-scripts.html#cb114-280" aria-hidden="true" tabindex="-1"></a><span class="co"># merge splines with x and y</span></span>
<span id="cb114-281"><a href="annex-i-compendium-of-r-scripts.html#cb114-281" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">select</span>(dat, ProfID, x, y))</span>
<span id="cb114-282"><a href="annex-i-compendium-of-r-scripts.html#cb114-282" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">left_join</span>(d, splines)</span>
<span id="cb114-283"><a href="annex-i-compendium-of-r-scripts.html#cb114-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-284"><a href="annex-i-compendium-of-r-scripts.html#cb114-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-285"><a href="annex-i-compendium-of-r-scripts.html#cb114-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-286"><a href="annex-i-compendium-of-r-scripts.html#cb114-286" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Harmonize units ==========================================================</span></span>
<span id="cb114-287"><a href="annex-i-compendium-of-r-scripts.html#cb114-287" aria-hidden="true" tabindex="-1"></a><span class="co">#Harmonize units if different from target units</span></span>
<span id="cb114-288"><a href="annex-i-compendium-of-r-scripts.html#cb114-288" aria-hidden="true" tabindex="-1"></a><span class="co"># Mandatory Soil Propertes and corresponing units:</span></span>
<span id="cb114-289"><a href="annex-i-compendium-of-r-scripts.html#cb114-289" aria-hidden="true" tabindex="-1"></a><span class="co"># Total N - ppm</span></span>
<span id="cb114-290"><a href="annex-i-compendium-of-r-scripts.html#cb114-290" aria-hidden="true" tabindex="-1"></a><span class="co"># Available P - ppm</span></span>
<span id="cb114-291"><a href="annex-i-compendium-of-r-scripts.html#cb114-291" aria-hidden="true" tabindex="-1"></a><span class="co"># Available K - ppm</span></span>
<span id="cb114-292"><a href="annex-i-compendium-of-r-scripts.html#cb114-292" aria-hidden="true" tabindex="-1"></a><span class="co"># Cation exchange capacity cmolc/kg</span></span>
<span id="cb114-293"><a href="annex-i-compendium-of-r-scripts.html#cb114-293" aria-hidden="true" tabindex="-1"></a><span class="co"># pH</span></span>
<span id="cb114-294"><a href="annex-i-compendium-of-r-scripts.html#cb114-294" aria-hidden="true" tabindex="-1"></a><span class="co"># SOC - %</span></span>
<span id="cb114-295"><a href="annex-i-compendium-of-r-scripts.html#cb114-295" aria-hidden="true" tabindex="-1"></a><span class="co"># Bulk density g/cm3</span></span>
<span id="cb114-296"><a href="annex-i-compendium-of-r-scripts.html#cb114-296" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil fractions (clay, silt and sand) - </span></span>
<span id="cb114-297"><a href="annex-i-compendium-of-r-scripts.html#cb114-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-298"><a href="annex-i-compendium-of-r-scripts.html#cb114-298" aria-hidden="true" tabindex="-1"></a><span class="co"># Units soil profile data (dataframe d)</span></span>
<span id="cb114-299"><a href="annex-i-compendium-of-r-scripts.html#cb114-299" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb114-300"><a href="annex-i-compendium-of-r-scripts.html#cb114-300" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d) <span class="co"># pH; K cmolc/kg; SOC %; BD g/cm3; CEC  cmolc/kg</span></span>
<span id="cb114-301"><a href="annex-i-compendium-of-r-scripts.html#cb114-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-302"><a href="annex-i-compendium-of-r-scripts.html#cb114-302" aria-hidden="true" tabindex="-1"></a><span class="co"># K =&gt; convert cmolc/kg to ppm (K *10 * 39.096)</span></span>
<span id="cb114-303"><a href="annex-i-compendium-of-r-scripts.html#cb114-303" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>k_0_30 <span class="ot">&lt;-</span> d<span class="sc">$</span>k_0_30 <span class="sc">*</span> <span class="dv">10</span> <span class="sc">*</span> <span class="fl">39.096</span></span>
<span id="cb114-304"><a href="annex-i-compendium-of-r-scripts.html#cb114-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-305"><a href="annex-i-compendium-of-r-scripts.html#cb114-305" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(chem)<span class="co"># P ppm; N %; K ppm</span></span>
<span id="cb114-306"><a href="annex-i-compendium-of-r-scripts.html#cb114-306" aria-hidden="true" tabindex="-1"></a><span class="co"># N =&gt; convert % to ppm (N * 10000)</span></span>
<span id="cb114-307"><a href="annex-i-compendium-of-r-scripts.html#cb114-307" aria-hidden="true" tabindex="-1"></a>chem<span class="sc">$</span>tn <span class="ot">&lt;-</span>chem<span class="sc">$</span>tn<span class="sc">*</span><span class="dv">10000</span></span>
<span id="cb114-308"><a href="annex-i-compendium-of-r-scripts.html#cb114-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-309"><a href="annex-i-compendium-of-r-scripts.html#cb114-309" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(phys)<span class="co"># clay, sand, silt g/kg</span></span>
<span id="cb114-310"><a href="annex-i-compendium-of-r-scripts.html#cb114-310" aria-hidden="true" tabindex="-1"></a><span class="co"># convert g/kg to % (/10)</span></span>
<span id="cb114-311"><a href="annex-i-compendium-of-r-scripts.html#cb114-311" aria-hidden="true" tabindex="-1"></a>phys<span class="sc">$</span>clay_0_30 <span class="ot">&lt;-</span>phys<span class="sc">$</span>clay_0_30<span class="sc">/</span><span class="dv">10</span></span>
<span id="cb114-312"><a href="annex-i-compendium-of-r-scripts.html#cb114-312" aria-hidden="true" tabindex="-1"></a>phys<span class="sc">$</span>sand_0_30  <span class="ot">&lt;-</span>phys<span class="sc">$</span>sand_0_30 <span class="sc">/</span><span class="dv">10</span></span>
<span id="cb114-313"><a href="annex-i-compendium-of-r-scripts.html#cb114-313" aria-hidden="true" tabindex="-1"></a>phys<span class="sc">$</span>silt_0_30 <span class="ot">&lt;-</span>phys<span class="sc">$</span>silt_0_30<span class="sc">/</span><span class="dv">10</span></span>
<span id="cb114-314"><a href="annex-i-compendium-of-r-scripts.html#cb114-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-315"><a href="annex-i-compendium-of-r-scripts.html#cb114-315" aria-hidden="true" tabindex="-1"></a><span class="co"># Correct negative clay content</span></span>
<span id="cb114-316"><a href="annex-i-compendium-of-r-scripts.html#cb114-316" aria-hidden="true" tabindex="-1"></a>phys<span class="sc">$</span>clay_0_30[phys<span class="sc">$</span>clay_0_30<span class="sc">&lt;</span><span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb114-317"><a href="annex-i-compendium-of-r-scripts.html#cb114-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-318"><a href="annex-i-compendium-of-r-scripts.html#cb114-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-319"><a href="annex-i-compendium-of-r-scripts.html#cb114-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Add chemical and physical properties from additional datasets ==========================</span></span>
<span id="cb114-320"><a href="annex-i-compendium-of-r-scripts.html#cb114-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-321"><a href="annex-i-compendium-of-r-scripts.html#cb114-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-322"><a href="annex-i-compendium-of-r-scripts.html#cb114-322" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename columns to match the main data set</span></span>
<span id="cb114-323"><a href="annex-i-compendium-of-r-scripts.html#cb114-323" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(d)</span>
<span id="cb114-324"><a href="annex-i-compendium-of-r-scripts.html#cb114-324" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(chem)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&#39;ProfID&#39;</span></span>
<span id="cb114-325"><a href="annex-i-compendium-of-r-scripts.html#cb114-325" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(chem)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">&#39;p_0_30&#39;</span></span>
<span id="cb114-326"><a href="annex-i-compendium-of-r-scripts.html#cb114-326" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(chem)[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="st">&#39;k_0_30&#39;</span> </span>
<span id="cb114-327"><a href="annex-i-compendium-of-r-scripts.html#cb114-327" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(chem)[<span class="dv">6</span>] <span class="ot">&lt;-</span> <span class="st">&#39;n_0_30&#39;</span></span>
<span id="cb114-328"><a href="annex-i-compendium-of-r-scripts.html#cb114-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-329"><a href="annex-i-compendium-of-r-scripts.html#cb114-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-330"><a href="annex-i-compendium-of-r-scripts.html#cb114-330" aria-hidden="true" tabindex="-1"></a><span class="co">#The chem dataframe comes from and independent dataset we need to create new unique ProfIDs </span></span>
<span id="cb114-331"><a href="annex-i-compendium-of-r-scripts.html#cb114-331" aria-hidden="true" tabindex="-1"></a><span class="co">#Create unique ProfID </span></span>
<span id="cb114-332"><a href="annex-i-compendium-of-r-scripts.html#cb114-332" aria-hidden="true" tabindex="-1"></a>chem<span class="sc">$</span>ProfID <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">max</span>(d<span class="sc">$</span>ProfID)<span class="sc">+</span><span class="dv">1</span>,<span class="fu">max</span>(d<span class="sc">$</span>ProfID)<span class="sc">+</span><span class="dv">1</span><span class="sc">+</span><span class="fu">nrow</span>(chem)<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb114-333"><a href="annex-i-compendium-of-r-scripts.html#cb114-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-334"><a href="annex-i-compendium-of-r-scripts.html#cb114-334" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the new data as new rows using dplyr we can add empty rows</span></span>
<span id="cb114-335"><a href="annex-i-compendium-of-r-scripts.html#cb114-335" aria-hidden="true" tabindex="-1"></a><span class="co"># automatically for the not measured properties in the chem dataset</span></span>
<span id="cb114-336"><a href="annex-i-compendium-of-r-scripts.html#cb114-336" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(d, chem)</span>
<span id="cb114-337"><a href="annex-i-compendium-of-r-scripts.html#cb114-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-338"><a href="annex-i-compendium-of-r-scripts.html#cb114-338" aria-hidden="true" tabindex="-1"></a><span class="co">#The phys dataframe with the texture instead shares the same ProfIDs (we can directly merge)</span></span>
<span id="cb114-339"><a href="annex-i-compendium-of-r-scripts.html#cb114-339" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">left_join</span>(d, phys, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;ProfID&#39;</span>, <span class="st">&#39;x&#39;</span>, <span class="st">&#39;y&#39;</span>))</span>
<span id="cb114-340"><a href="annex-i-compendium-of-r-scripts.html#cb114-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-341"><a href="annex-i-compendium-of-r-scripts.html#cb114-341" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 - Plot  and save results ===================================================</span></span>
<span id="cb114-342"><a href="annex-i-compendium-of-r-scripts.html#cb114-342" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(d)</span>
<span id="cb114-343"><a href="annex-i-compendium-of-r-scripts.html#cb114-343" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(d, <span class="at">cols =</span> ph_0_30<span class="sc">:</span>silt_0_30, <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>,</span>
<span id="cb114-344"><a href="annex-i-compendium-of-r-scripts.html#cb114-344" aria-hidden="true" tabindex="-1"></a>                  <span class="at">names_sep =</span> <span class="st">&quot;_&quot;</span>, </span>
<span id="cb114-345"><a href="annex-i-compendium-of-r-scripts.html#cb114-345" aria-hidden="true" tabindex="-1"></a>                  <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">&quot;soil_property&quot;</span>, <span class="st">&quot;top&quot;</span>, <span class="st">&quot;bottom&quot;</span>))</span>
<span id="cb114-346"><a href="annex-i-compendium-of-r-scripts.html#cb114-346" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">mutate</span>(x, <span class="at">depth =</span> <span class="fu">paste</span>(top, <span class="st">&quot;-&quot;</span> , bottom))</span>
<span id="cb114-347"><a href="annex-i-compendium-of-r-scripts.html#cb114-347" aria-hidden="true" tabindex="-1"></a><span class="co">#x &lt;- na.omit(x)</span></span>
<span id="cb114-348"><a href="annex-i-compendium-of-r-scripts.html#cb114-348" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(x, <span class="fu">aes</span>(<span class="at">x =</span> depth, <span class="at">y =</span> value, <span class="at">fill =</span> soil_property)) <span class="sc">+</span></span>
<span id="cb114-349"><a href="annex-i-compendium-of-r-scripts.html#cb114-349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb114-350"><a href="annex-i-compendium-of-r-scripts.html#cb114-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>soil_property, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>)</span>
<span id="cb114-351"><a href="annex-i-compendium-of-r-scripts.html#cb114-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-352"><a href="annex-i-compendium-of-r-scripts.html#cb114-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-353"><a href="annex-i-compendium-of-r-scripts.html#cb114-353" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(<span class="fu">ggplot</span>(x, <span class="fu">aes</span>(<span class="at">x =</span> depth, <span class="at">y =</span> value, <span class="at">fill =</span> soil_property)) <span class="sc">+</span></span>
<span id="cb114-354"><a href="annex-i-compendium-of-r-scripts.html#cb114-354" aria-hidden="true" tabindex="-1"></a>           <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb114-355"><a href="annex-i-compendium-of-r-scripts.html#cb114-355" aria-hidden="true" tabindex="-1"></a>           <span class="fu">facet_wrap</span>(<span class="sc">~</span>soil_property, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>))</span>
<span id="cb114-356"><a href="annex-i-compendium-of-r-scripts.html#cb114-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-357"><a href="annex-i-compendium-of-r-scripts.html#cb114-357" aria-hidden="true" tabindex="-1"></a><span class="co"># save the data</span></span>
<span id="cb114-358"><a href="annex-i-compendium-of-r-scripts.html#cb114-358" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d, <span class="st">&quot;02-Outputs/harmonized_soil_data.csv&quot;</span>)</span></code></pre></div>
</div>
<div id="scripts-3-download-environmental-covariates" class="section level2 unnumbered hasAnchor">
<h2>Scripts 3: Download environmental covariates<a href="annex-i-compendium-of-r-scripts.html#scripts-3-download-environmental-covariates" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb115"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb115-1"><a href="annex-i-compendium-of-r-scripts.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> assets <span class="op">=</span> [<span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio1&quot;</span><span class="op">,</span></span>
<span id="cb115-2"><a href="annex-i-compendium-of-r-scripts.html#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio12&quot;</span><span class="op">,</span></span>
<span id="cb115-3"><a href="annex-i-compendium-of-r-scripts.html#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio13&quot;</span><span class="op">,</span></span>
<span id="cb115-4"><a href="annex-i-compendium-of-r-scripts.html#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio14&quot;</span><span class="op">,</span></span>
<span id="cb115-5"><a href="annex-i-compendium-of-r-scripts.html#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio16&quot;</span><span class="op">,</span></span>
<span id="cb115-6"><a href="annex-i-compendium-of-r-scripts.html#cb115-6" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio17&quot;</span><span class="op">,</span></span>
<span id="cb115-7"><a href="annex-i-compendium-of-r-scripts.html#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio5&quot;</span><span class="op">,</span></span>
<span id="cb115-8"><a href="annex-i-compendium-of-r-scripts.html#cb115-8" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/bio6&quot;</span><span class="op">,</span></span>
<span id="cb115-9"><a href="annex-i-compendium-of-r-scripts.html#cb115-9" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/ngd10&quot;</span><span class="op">,</span></span>
<span id="cb115-10"><a href="annex-i-compendium-of-r-scripts.html#cb115-10" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_max&quot;</span><span class="op">,</span></span>
<span id="cb115-11"><a href="annex-i-compendium-of-r-scripts.html#cb115-11" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-12"><a href="annex-i-compendium-of-r-scripts.html#cb115-12" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_min&quot;</span><span class="op">,</span></span>
<span id="cb115-13"><a href="annex-i-compendium-of-r-scripts.html#cb115-13" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/pet_penman_range&quot;</span><span class="op">,</span></span>
<span id="cb115-14"><a href="annex-i-compendium-of-r-scripts.html#cb115-14" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/sfcWind_max&quot;</span><span class="op">,</span></span>
<span id="cb115-15"><a href="annex-i-compendium-of-r-scripts.html#cb115-15" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/sfcWind_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-16"><a href="annex-i-compendium-of-r-scripts.html#cb115-16" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/CHELSA/sfcWind_range&quot;</span><span class="op">,</span></span>
<span id="cb115-17"><a href="annex-i-compendium-of-r-scripts.html#cb115-17" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_030405_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-18"><a href="annex-i-compendium-of-r-scripts.html#cb115-18" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_030405_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-19"><a href="annex-i-compendium-of-r-scripts.html#cb115-19" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_060708_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-20"><a href="annex-i-compendium-of-r-scripts.html#cb115-20" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_060708_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-21"><a href="annex-i-compendium-of-r-scripts.html#cb115-21" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_091011_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-22"><a href="annex-i-compendium-of-r-scripts.html#cb115-22" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_091011_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-23"><a href="annex-i-compendium-of-r-scripts.html#cb115-23" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_120102_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-24"><a href="annex-i-compendium-of-r-scripts.html#cb115-24" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/fpar_120102_500m_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-25"><a href="annex-i-compendium-of-r-scripts.html#cb115-25" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_030405_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-26"><a href="annex-i-compendium-of-r-scripts.html#cb115-26" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_030405_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-27"><a href="annex-i-compendium-of-r-scripts.html#cb115-27" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_060708_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-28"><a href="annex-i-compendium-of-r-scripts.html#cb115-28" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_060708_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-29"><a href="annex-i-compendium-of-r-scripts.html#cb115-29" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_091011_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-30"><a href="annex-i-compendium-of-r-scripts.html#cb115-30" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_091011_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-31"><a href="annex-i-compendium-of-r-scripts.html#cb115-31" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_120102_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-32"><a href="annex-i-compendium-of-r-scripts.html#cb115-32" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/lstd_120102_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-33"><a href="annex-i-compendium-of-r-scripts.html#cb115-33" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_030405_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-34"><a href="annex-i-compendium-of-r-scripts.html#cb115-34" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_030405_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-35"><a href="annex-i-compendium-of-r-scripts.html#cb115-35" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_060708_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-36"><a href="annex-i-compendium-of-r-scripts.html#cb115-36" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_060708_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-37"><a href="annex-i-compendium-of-r-scripts.html#cb115-37" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_091011_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-38"><a href="annex-i-compendium-of-r-scripts.html#cb115-38" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_091011_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-39"><a href="annex-i-compendium-of-r-scripts.html#cb115-39" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_120102_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-40"><a href="annex-i-compendium-of-r-scripts.html#cb115-40" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndlst_120102_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-41"><a href="annex-i-compendium-of-r-scripts.html#cb115-41" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_030405_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-42"><a href="annex-i-compendium-of-r-scripts.html#cb115-42" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_030405_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-43"><a href="annex-i-compendium-of-r-scripts.html#cb115-43" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_060708_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-44"><a href="annex-i-compendium-of-r-scripts.html#cb115-44" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_060708_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-45"><a href="annex-i-compendium-of-r-scripts.html#cb115-45" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_091011_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-46"><a href="annex-i-compendium-of-r-scripts.html#cb115-46" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_091011_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-47"><a href="annex-i-compendium-of-r-scripts.html#cb115-47" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_120102_250m_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-48"><a href="annex-i-compendium-of-r-scripts.html#cb115-48" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/ndvi_120102_250m_sd&quot;</span><span class="op">,</span></span>
<span id="cb115-49"><a href="annex-i-compendium-of-r-scripts.html#cb115-49" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/snow_cover&quot;</span><span class="op">,</span></span>
<span id="cb115-50"><a href="annex-i-compendium-of-r-scripts.html#cb115-50" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/MODIS/swir_060708_500m_mean&quot;</span><span class="op">,</span></span>
<span id="cb115-51"><a href="annex-i-compendium-of-r-scripts.html#cb115-51" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/crops&quot;</span><span class="op">,</span></span>
<span id="cb115-52"><a href="annex-i-compendium-of-r-scripts.html#cb115-52" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/flooded_vegetation&quot;</span><span class="op">,</span></span>
<span id="cb115-53"><a href="annex-i-compendium-of-r-scripts.html#cb115-53" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/grass&quot;</span><span class="op">,</span></span>
<span id="cb115-54"><a href="annex-i-compendium-of-r-scripts.html#cb115-54" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/shrub_and_scrub&quot;</span><span class="op">,</span></span>
<span id="cb115-55"><a href="annex-i-compendium-of-r-scripts.html#cb115-55" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER/trees&quot;</span><span class="op">,</span></span>
<span id="cb115-56"><a href="annex-i-compendium-of-r-scripts.html#cb115-56" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_curvature_250m&quot;</span><span class="op">,</span></span>
<span id="cb115-57"><a href="annex-i-compendium-of-r-scripts.html#cb115-57" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_downslopecurvature_250m&quot;</span><span class="op">,</span></span>
<span id="cb115-58"><a href="annex-i-compendium-of-r-scripts.html#cb115-58" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_dvm2_250m&quot;</span><span class="op">,</span></span>
<span id="cb115-59"><a href="annex-i-compendium-of-r-scripts.html#cb115-59" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_dvm_250m&quot;</span><span class="op">,</span></span>
<span id="cb115-60"><a href="annex-i-compendium-of-r-scripts.html#cb115-60" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_elevation_250m&quot;</span><span class="op">,</span></span>
<span id="cb115-61"><a href="annex-i-compendium-of-r-scripts.html#cb115-61" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_mrn_250m&quot;</span><span class="op">,</span></span>
<span id="cb115-62"><a href="annex-i-compendium-of-r-scripts.html#cb115-62" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_neg_openness_250m&quot;</span><span class="op">,</span></span>
<span id="cb115-63"><a href="annex-i-compendium-of-r-scripts.html#cb115-63" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_pos_openness_250m&quot;</span><span class="op">,</span></span>
<span id="cb115-64"><a href="annex-i-compendium-of-r-scripts.html#cb115-64" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_slope_250m&quot;</span><span class="op">,</span></span>
<span id="cb115-65"><a href="annex-i-compendium-of-r-scripts.html#cb115-65" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_tpi_250m&quot;</span><span class="op">,</span></span>
<span id="cb115-66"><a href="annex-i-compendium-of-r-scripts.html#cb115-66" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_twi_500m&quot;</span><span class="op">,</span></span>
<span id="cb115-67"><a href="annex-i-compendium-of-r-scripts.html#cb115-67" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_upslopecurvature_250m&quot;</span><span class="op">,</span></span>
<span id="cb115-68"><a href="annex-i-compendium-of-r-scripts.html#cb115-68" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP/dtm_vbf_250m&quot;</span>]<span class="op">;</span></span>
<span id="cb115-69"><a href="annex-i-compendium-of-r-scripts.html#cb115-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-70"><a href="annex-i-compendium-of-r-scripts.html#cb115-70" aria-hidden="true" tabindex="-1"></a><span class="co">// Load borders </span></span>
<span id="cb115-71"><a href="annex-i-compendium-of-r-scripts.html#cb115-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-72"><a href="annex-i-compendium-of-r-scripts.html#cb115-72" aria-hidden="true" tabindex="-1"></a><span class="co">/// Using LSIB 2017 (replace the countries that you want to download)</span></span>
<span id="cb115-73"><a href="annex-i-compendium-of-r-scripts.html#cb115-73" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> country_list <span class="op">=</span> [<span class="st">&#39;Italy&#39;</span>]<span class="op">;</span></span>
<span id="cb115-74"><a href="annex-i-compendium-of-r-scripts.html#cb115-74" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> aoi <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;USDOS/LSIB_SIMPLE/2017&#39;</span>)</span>
<span id="cb115-75"><a href="annex-i-compendium-of-r-scripts.html#cb115-75" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">inList</span>(<span class="st">&#39;country_na&#39;</span><span class="op">,</span> country_list))<span class="op">;</span></span>
<span id="cb115-76"><a href="annex-i-compendium-of-r-scripts.html#cb115-76" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> region <span class="op">=</span> aoi<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb115-77"><a href="annex-i-compendium-of-r-scripts.html#cb115-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-78"><a href="annex-i-compendium-of-r-scripts.html#cb115-78" aria-hidden="true" tabindex="-1"></a><span class="co">/// Using a shapefile</span></span>
<span id="cb115-79"><a href="annex-i-compendium-of-r-scripts.html#cb115-79" aria-hidden="true" tabindex="-1"></a><span class="co">/// 1. Upload the borders of your countries as an asset</span></span>
<span id="cb115-80"><a href="annex-i-compendium-of-r-scripts.html#cb115-80" aria-hidden="true" tabindex="-1"></a><span class="co">/// 2. Replace &#39;your_shapefile&#39; with the path to your shapefile</span></span>
<span id="cb115-81"><a href="annex-i-compendium-of-r-scripts.html#cb115-81" aria-hidden="true" tabindex="-1"></a><span class="co">// var shapefile = ee.FeatureCollection(&#39;users/your_username/your_shapefile&#39;);</span></span>
<span id="cb115-82"><a href="annex-i-compendium-of-r-scripts.html#cb115-82" aria-hidden="true" tabindex="-1"></a><span class="co">// var region = shapefile.geometry();</span></span>
<span id="cb115-83"><a href="annex-i-compendium-of-r-scripts.html#cb115-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-84"><a href="annex-i-compendium-of-r-scripts.html#cb115-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-85"><a href="annex-i-compendium-of-r-scripts.html#cb115-85" aria-hidden="true" tabindex="-1"></a><span class="co">// Load assets as ImageCollection</span></span>
<span id="cb115-86"><a href="annex-i-compendium-of-r-scripts.html#cb115-86" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> assetsCollection <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(assets)<span class="op">;</span></span>
<span id="cb115-87"><a href="annex-i-compendium-of-r-scripts.html#cb115-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-88"><a href="annex-i-compendium-of-r-scripts.html#cb115-88" aria-hidden="true" tabindex="-1"></a><span class="co">// Clip each image in the collection to the region of interest</span></span>
<span id="cb115-89"><a href="annex-i-compendium-of-r-scripts.html#cb115-89" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clippedCollection <span class="op">=</span> assetsCollection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(img){</span>
<span id="cb115-90"><a href="annex-i-compendium-of-r-scripts.html#cb115-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> img<span class="op">.</span><span class="fu">clip</span>(region)<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb115-91"><a href="annex-i-compendium-of-r-scripts.html#cb115-91" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb115-92"><a href="annex-i-compendium-of-r-scripts.html#cb115-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-93"><a href="annex-i-compendium-of-r-scripts.html#cb115-93" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to replace masked values with zeroes for fpar bands</span></span>
<span id="cb115-94"><a href="annex-i-compendium-of-r-scripts.html#cb115-94" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">replaceMaskedFpar</span>(img) {</span>
<span id="cb115-95"><a href="annex-i-compendium-of-r-scripts.html#cb115-95" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> allBands <span class="op">=</span> img<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb115-96"><a href="annex-i-compendium-of-r-scripts.html#cb115-96" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> fparBands <span class="op">=</span> allBands<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">stringStartsWith</span>(<span class="st">&#39;item&#39;</span><span class="op">,</span> <span class="st">&#39;fpar&#39;</span>))<span class="op">;</span></span>
<span id="cb115-97"><a href="annex-i-compendium-of-r-scripts.html#cb115-97" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> nonFparBands <span class="op">=</span> allBands<span class="op">.</span><span class="fu">removeAll</span>(fparBands)<span class="op">;</span></span>
<span id="cb115-98"><a href="annex-i-compendium-of-r-scripts.html#cb115-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-99"><a href="annex-i-compendium-of-r-scripts.html#cb115-99" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> fparImg <span class="op">=</span> img<span class="op">.</span><span class="fu">select</span>(fparBands)<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb115-100"><a href="annex-i-compendium-of-r-scripts.html#cb115-100" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> nonFparImg <span class="op">=</span> img<span class="op">.</span><span class="fu">select</span>(nonFparBands)<span class="op">;</span></span>
<span id="cb115-101"><a href="annex-i-compendium-of-r-scripts.html#cb115-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-102"><a href="annex-i-compendium-of-r-scripts.html#cb115-102" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If there are no fpar bands, return the original image</span></span>
<span id="cb115-103"><a href="annex-i-compendium-of-r-scripts.html#cb115-103" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(fparBands<span class="op">.</span><span class="fu">length</span>()<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb115-104"><a href="annex-i-compendium-of-r-scripts.html#cb115-104" aria-hidden="true" tabindex="-1"></a>                                 img<span class="op">,</span></span>
<span id="cb115-105"><a href="annex-i-compendium-of-r-scripts.html#cb115-105" aria-hidden="true" tabindex="-1"></a>                                 nonFparImg<span class="op">.</span><span class="fu">addBands</span>(fparImg))<span class="op">;</span></span>
<span id="cb115-106"><a href="annex-i-compendium-of-r-scripts.html#cb115-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-107"><a href="annex-i-compendium-of-r-scripts.html#cb115-107" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(result)<span class="op">;</span></span>
<span id="cb115-108"><a href="annex-i-compendium-of-r-scripts.html#cb115-108" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb115-109"><a href="annex-i-compendium-of-r-scripts.html#cb115-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-110"><a href="annex-i-compendium-of-r-scripts.html#cb115-110" aria-hidden="true" tabindex="-1"></a><span class="co">// Clip each image in the collection to the region of interest and replace masked values for fpar bands</span></span>
<span id="cb115-111"><a href="annex-i-compendium-of-r-scripts.html#cb115-111" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clippedCollection <span class="op">=</span> assetsCollection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(img){</span>
<span id="cb115-112"><a href="annex-i-compendium-of-r-scripts.html#cb115-112" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> clippedImg <span class="op">=</span> img<span class="op">.</span><span class="fu">clip</span>(region)<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb115-113"><a href="annex-i-compendium-of-r-scripts.html#cb115-113" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">replaceMaskedFpar</span>(clippedImg)<span class="op">;</span></span>
<span id="cb115-114"><a href="annex-i-compendium-of-r-scripts.html#cb115-114" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb115-115"><a href="annex-i-compendium-of-r-scripts.html#cb115-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-116"><a href="annex-i-compendium-of-r-scripts.html#cb115-116" aria-hidden="true" tabindex="-1"></a><span class="co">// Stack the layers and maintain the layer names in the final file</span></span>
<span id="cb115-117"><a href="annex-i-compendium-of-r-scripts.html#cb115-117" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stacked <span class="op">=</span> clippedCollection<span class="op">.</span><span class="fu">toBands</span>()<span class="op">;</span></span>
<span id="cb115-118"><a href="annex-i-compendium-of-r-scripts.html#cb115-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-119"><a href="annex-i-compendium-of-r-scripts.html#cb115-119" aria-hidden="true" tabindex="-1"></a><span class="co">// Get the list of asset names</span></span>
<span id="cb115-120"><a href="annex-i-compendium-of-r-scripts.html#cb115-120" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> assetNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(assets)<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(asset) {</span>
<span id="cb115-121"><a href="annex-i-compendium-of-r-scripts.html#cb115-121" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">String</span>(asset)<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">.</span><span class="fu">get</span>(<span class="op">-</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb115-122"><a href="annex-i-compendium-of-r-scripts.html#cb115-122" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb115-123"><a href="annex-i-compendium-of-r-scripts.html#cb115-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-124"><a href="annex-i-compendium-of-r-scripts.html#cb115-124" aria-hidden="true" tabindex="-1"></a><span class="co">// Rename the bands with asset names</span></span>
<span id="cb115-125"><a href="annex-i-compendium-of-r-scripts.html#cb115-125" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> renamed <span class="op">=</span> stacked<span class="op">.</span><span class="fu">rename</span>(assetNames)<span class="op">;</span></span>
<span id="cb115-126"><a href="annex-i-compendium-of-r-scripts.html#cb115-126" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(renamed<span class="op">,</span> <span class="st">&#39;Covariates to be exported&#39;</span>)</span>
<span id="cb115-127"><a href="annex-i-compendium-of-r-scripts.html#cb115-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-128"><a href="annex-i-compendium-of-r-scripts.html#cb115-128" aria-hidden="true" tabindex="-1"></a><span class="co">// Visualize the result</span></span>
<span id="cb115-129"><a href="annex-i-compendium-of-r-scripts.html#cb115-129" aria-hidden="true" tabindex="-1"></a><span class="co">// Set a visualization parameter (you can adjust the colors as desired)</span></span>
<span id="cb115-130"><a href="annex-i-compendium-of-r-scripts.html#cb115-130" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb115-131"><a href="annex-i-compendium-of-r-scripts.html#cb115-131" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> <span class="st">&#39;bio1&#39;</span><span class="op">,</span></span>
<span id="cb115-132"><a href="annex-i-compendium-of-r-scripts.html#cb115-132" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb115-133"><a href="annex-i-compendium-of-r-scripts.html#cb115-133" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb115-134"><a href="annex-i-compendium-of-r-scripts.html#cb115-134" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="st">&#39;yellow&#39;</span><span class="op">,</span> <span class="st">&#39;red&#39;</span>]</span>
<span id="cb115-135"><a href="annex-i-compendium-of-r-scripts.html#cb115-135" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb115-136"><a href="annex-i-compendium-of-r-scripts.html#cb115-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-137"><a href="annex-i-compendium-of-r-scripts.html#cb115-137" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the layer to the map</span></span>
<span id="cb115-138"><a href="annex-i-compendium-of-r-scripts.html#cb115-138" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(renamed<span class="op">,</span> <span class="dv">6</span>)</span>
<span id="cb115-139"><a href="annex-i-compendium-of-r-scripts.html#cb115-139" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(renamed<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Covariates&#39;</span>)<span class="op">;</span></span>
<span id="cb115-140"><a href="annex-i-compendium-of-r-scripts.html#cb115-140" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the stacked image to Google Drive</span></span>
<span id="cb115-141"><a href="annex-i-compendium-of-r-scripts.html#cb115-141" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb115-142"><a href="annex-i-compendium-of-r-scripts.html#cb115-142" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> renamed<span class="op">,</span></span>
<span id="cb115-143"><a href="annex-i-compendium-of-r-scripts.html#cb115-143" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;covariates&#39;</span><span class="op">,</span></span>
<span id="cb115-144"><a href="annex-i-compendium-of-r-scripts.html#cb115-144" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;GEE&#39;</span><span class="op">,</span></span>
<span id="cb115-145"><a href="annex-i-compendium-of-r-scripts.html#cb115-145" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb115-146"><a href="annex-i-compendium-of-r-scripts.html#cb115-146" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span><span class="op">,</span></span>
<span id="cb115-147"><a href="annex-i-compendium-of-r-scripts.html#cb115-147" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> region</span>
<span id="cb115-148"><a href="annex-i-compendium-of-r-scripts.html#cb115-148" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb115-149"><a href="annex-i-compendium-of-r-scripts.html#cb115-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-150"><a href="annex-i-compendium-of-r-scripts.html#cb115-150" aria-hidden="true" tabindex="-1"></a><span class="co">/* Create mask for croplands ----------------------------*/</span></span>
<span id="cb115-151"><a href="annex-i-compendium-of-r-scripts.html#cb115-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-152"><a href="annex-i-compendium-of-r-scripts.html#cb115-152" aria-hidden="true" tabindex="-1"></a><span class="co">// Load the Copernicus Global Land Service image collection</span></span>
<span id="cb115-153"><a href="annex-i-compendium-of-r-scripts.html#cb115-153" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> imageCollection <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;COPERNICUS/Landcover/100m/Proba-V-C3/Global/2019&quot;</span>)</span>
<span id="cb115-154"><a href="annex-i-compendium-of-r-scripts.html#cb115-154" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&quot;discrete_classification&quot;</span>)</span>
<span id="cb115-155"><a href="annex-i-compendium-of-r-scripts.html#cb115-155" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">clip</span>(region)</span>
<span id="cb115-156"><a href="annex-i-compendium-of-r-scripts.html#cb115-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-157"><a href="annex-i-compendium-of-r-scripts.html#cb115-157" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> crs <span class="op">=</span> <span class="st">&#39;EPSG:4326&#39;</span><span class="op">;</span> <span class="co">// WGS84</span></span>
<span id="cb115-158"><a href="annex-i-compendium-of-r-scripts.html#cb115-158" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> res <span class="op">=</span> <span class="dv">250</span><span class="op">;</span> <span class="co">// Resolution in decimal degrees</span></span>
<span id="cb115-159"><a href="annex-i-compendium-of-r-scripts.html#cb115-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-160"><a href="annex-i-compendium-of-r-scripts.html#cb115-160" aria-hidden="true" tabindex="-1"></a><span class="co">// Default resampling is nearest neighbor</span></span>
<span id="cb115-161"><a href="annex-i-compendium-of-r-scripts.html#cb115-161" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image1 <span class="op">=</span> imageCollection<span class="op">.</span><span class="fu">resample</span>()</span>
<span id="cb115-162"><a href="annex-i-compendium-of-r-scripts.html#cb115-162" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">reproject</span>({</span>
<span id="cb115-163"><a href="annex-i-compendium-of-r-scripts.html#cb115-163" aria-hidden="true" tabindex="-1"></a>    <span class="dt">crs</span><span class="op">:</span> crs<span class="op">,</span> <span class="co">// Add your desired CRS here</span></span>
<span id="cb115-164"><a href="annex-i-compendium-of-r-scripts.html#cb115-164" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> res <span class="co">// Add your desired scale here</span></span>
<span id="cb115-165"><a href="annex-i-compendium-of-r-scripts.html#cb115-165" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb115-166"><a href="annex-i-compendium-of-r-scripts.html#cb115-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-167"><a href="annex-i-compendium-of-r-scripts.html#cb115-167" aria-hidden="true" tabindex="-1"></a><span class="co">// Reclassify the land cover classes</span></span>
<span id="cb115-168"><a href="annex-i-compendium-of-r-scripts.html#cb115-168" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> inList <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">40</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">60</span><span class="op">,</span> <span class="dv">70</span><span class="op">,</span> <span class="dv">80</span><span class="op">,</span> <span class="dv">90</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="dv">111</span><span class="op">,</span> <span class="dv">112</span><span class="op">,</span> <span class="dv">113</span><span class="op">,</span> <span class="dv">114</span><span class="op">,</span> <span class="dv">115</span><span class="op">,</span> <span class="dv">116</span><span class="op">,</span> </span>
<span id="cb115-169"><a href="annex-i-compendium-of-r-scripts.html#cb115-169" aria-hidden="true" tabindex="-1"></a>              <span class="dv">121</span><span class="op">,</span> <span class="dv">122</span><span class="op">,</span> <span class="dv">123</span><span class="op">,</span> <span class="dv">124</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">126</span><span class="op">,</span> <span class="dv">200</span>]<span class="op">;</span></span>
<span id="cb115-170"><a href="annex-i-compendium-of-r-scripts.html#cb115-170" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> outList <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb115-171"><a href="annex-i-compendium-of-r-scripts.html#cb115-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-172"><a href="annex-i-compendium-of-r-scripts.html#cb115-172" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> FAO_lu <span class="op">=</span> image1<span class="op">.</span><span class="fu">remap</span>(inList<span class="op">,</span> outList)</span>
<span id="cb115-173"><a href="annex-i-compendium-of-r-scripts.html#cb115-173" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">toDouble</span>()</span>
<span id="cb115-174"><a href="annex-i-compendium-of-r-scripts.html#cb115-174" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">clip</span>(region)<span class="op">;</span></span>
<span id="cb115-175"><a href="annex-i-compendium-of-r-scripts.html#cb115-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-176"><a href="annex-i-compendium-of-r-scripts.html#cb115-176" aria-hidden="true" tabindex="-1"></a><span class="co">// print(FAO_lu)</span></span>
<span id="cb115-177"><a href="annex-i-compendium-of-r-scripts.html#cb115-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-178"><a href="annex-i-compendium-of-r-scripts.html#cb115-178" aria-hidden="true" tabindex="-1"></a><span class="co">// Convert 0 to NA</span></span>
<span id="cb115-179"><a href="annex-i-compendium-of-r-scripts.html#cb115-179" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mask <span class="op">=</span> FAO_lu<span class="op">.</span><span class="fu">neq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb115-180"><a href="annex-i-compendium-of-r-scripts.html#cb115-180" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mask)</span>
<span id="cb115-181"><a href="annex-i-compendium-of-r-scripts.html#cb115-181" aria-hidden="true" tabindex="-1"></a>FAO_lu <span class="op">=</span> FAO_lu<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb115-182"><a href="annex-i-compendium-of-r-scripts.html#cb115-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-183"><a href="annex-i-compendium-of-r-scripts.html#cb115-183" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(FAO_lu<span class="op">,</span> <span class="st">&quot;Mask&quot;</span>)</span>
<span id="cb115-184"><a href="annex-i-compendium-of-r-scripts.html#cb115-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-185"><a href="annex-i-compendium-of-r-scripts.html#cb115-185" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb115-186"><a href="annex-i-compendium-of-r-scripts.html#cb115-186" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> <span class="st">&#39;remapped&#39;</span><span class="op">,</span></span>
<span id="cb115-187"><a href="annex-i-compendium-of-r-scripts.html#cb115-187" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb115-188"><a href="annex-i-compendium-of-r-scripts.html#cb115-188" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb115-189"><a href="annex-i-compendium-of-r-scripts.html#cb115-189" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="st">&#39;yellow&#39;</span>]</span>
<span id="cb115-190"><a href="annex-i-compendium-of-r-scripts.html#cb115-190" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb115-191"><a href="annex-i-compendium-of-r-scripts.html#cb115-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-192"><a href="annex-i-compendium-of-r-scripts.html#cb115-192" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the layer to the map</span></span>
<span id="cb115-193"><a href="annex-i-compendium-of-r-scripts.html#cb115-193" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(FAO_lu<span class="op">,</span>visParams <span class="op">,</span><span class="st">&#39;Mask&#39;</span>)<span class="op">;</span></span>
<span id="cb115-194"><a href="annex-i-compendium-of-r-scripts.html#cb115-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-195"><a href="annex-i-compendium-of-r-scripts.html#cb115-195" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the land cover image as a raster to Google Drive</span></span>
<span id="cb115-196"><a href="annex-i-compendium-of-r-scripts.html#cb115-196" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb115-197"><a href="annex-i-compendium-of-r-scripts.html#cb115-197" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> FAO_lu<span class="op">,</span></span>
<span id="cb115-198"><a href="annex-i-compendium-of-r-scripts.html#cb115-198" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;GEE&#39;</span><span class="op">,</span></span>
<span id="cb115-199"><a href="annex-i-compendium-of-r-scripts.html#cb115-199" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;mask&#39;</span><span class="op">,</span></span>
<span id="cb115-200"><a href="annex-i-compendium-of-r-scripts.html#cb115-200" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> res<span class="op">,</span> <span class="co">// Add your desired scale here</span></span>
<span id="cb115-201"><a href="annex-i-compendium-of-r-scripts.html#cb115-201" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> region<span class="op">,</span></span>
<span id="cb115-202"><a href="annex-i-compendium-of-r-scripts.html#cb115-202" aria-hidden="true" tabindex="-1"></a>  <span class="dt">crs</span><span class="op">:</span> crs<span class="op">,</span> <span class="co">// Add your desired CRS here</span></span>
<span id="cb115-203"><a href="annex-i-compendium-of-r-scripts.html#cb115-203" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span> <span class="co">// Add a maximum number of pixels for export if needed</span></span>
<span id="cb115-204"><a href="annex-i-compendium-of-r-scripts.html#cb115-204" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="annex-i-compendium-of-r-scripts.html#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create terrain derivatives from MERIT-DEM and </span></span>
<span id="cb116-2"><a href="annex-i-compendium-of-r-scripts.html#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="co"># harmonise their format with the rest of the covariates </span></span>
<span id="cb116-3"><a href="annex-i-compendium-of-r-scripts.html#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Marcos Angelini, Luis Rodrguez Lado &amp; Isabel Luotto</span></span>
<span id="cb116-4"><a href="annex-i-compendium-of-r-scripts.html#cb116-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Global Soil Partnership - FAO</span></span>
<span id="cb116-5"><a href="annex-i-compendium-of-r-scripts.html#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb116-6"><a href="annex-i-compendium-of-r-scripts.html#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;C:/GIT/GSNmap-TM/Digital-Soil-Mapping/&quot;</span>)</span>
<span id="cb116-7"><a href="annex-i-compendium-of-r-scripts.html#cb116-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-8"><a href="annex-i-compendium-of-r-scripts.html#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb116-9"><a href="annex-i-compendium-of-r-scripts.html#cb116-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(terra)</span>
<span id="cb116-10"><a href="annex-i-compendium-of-r-scripts.html#cb116-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(raster)</span>
<span id="cb116-11"><a href="annex-i-compendium-of-r-scripts.html#cb116-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-12"><a href="annex-i-compendium-of-r-scripts.html#cb116-12" aria-hidden="true" tabindex="-1"></a><span class="co"># import high resolution raster  </span></span>
<span id="cb116-13"><a href="annex-i-compendium-of-r-scripts.html#cb116-13" aria-hidden="true" tabindex="-1"></a>dem <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;01-Data/create_covariates/MERIT_DEM.tif&quot;</span>)</span>
<span id="cb116-14"><a href="annex-i-compendium-of-r-scripts.html#cb116-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-15"><a href="annex-i-compendium-of-r-scripts.html#cb116-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot DEM</span></span>
<span id="cb116-16"><a href="annex-i-compendium-of-r-scripts.html#cb116-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dem)</span>
<span id="cb116-17"><a href="annex-i-compendium-of-r-scripts.html#cb116-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-18"><a href="annex-i-compendium-of-r-scripts.html#cb116-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain DEM derived maps</span></span>
<span id="cb116-19"><a href="annex-i-compendium-of-r-scripts.html#cb116-19" aria-hidden="true" tabindex="-1"></a>derived_vars <span class="ot">&lt;-</span> <span class="fu">terrain</span>(dem, </span>
<span id="cb116-20"><a href="annex-i-compendium-of-r-scripts.html#cb116-20" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">c</span>(<span class="st">&quot;slope&quot;</span>, <span class="st">&quot;roughness&quot;</span>, <span class="st">&quot;aspect&quot;</span>, <span class="st">&quot;flowdir&quot;</span>, </span>
<span id="cb116-21"><a href="annex-i-compendium-of-r-scripts.html#cb116-21" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;aspect&quot;</span>,<span class="st">&quot;TPI&quot;</span>, <span class="st">&quot;TRI&quot;</span>, <span class="st">&quot;TRIriley&quot;</span>, <span class="st">&quot;TRIrmsd&quot;</span>), </span>
<span id="cb116-22"><a href="annex-i-compendium-of-r-scripts.html#cb116-22" aria-hidden="true" tabindex="-1"></a>                        <span class="at">unit =</span> <span class="st">&quot;degrees&quot;</span>)</span>
<span id="cb116-23"><a href="annex-i-compendium-of-r-scripts.html#cb116-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-24"><a href="annex-i-compendium-of-r-scripts.html#cb116-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(derived_vars, <span class="at">nc=</span><span class="dv">3</span>, <span class="at">nr=</span><span class="dv">3</span>)</span>
<span id="cb116-25"><a href="annex-i-compendium-of-r-scripts.html#cb116-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-26"><a href="annex-i-compendium-of-r-scripts.html#cb116-26" aria-hidden="true" tabindex="-1"></a><span class="co"># load rster of reference</span></span>
<span id="cb116-27"><a href="annex-i-compendium-of-r-scripts.html#cb116-27" aria-hidden="true" tabindex="-1"></a>ref <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;01-Data/covs/Covariates.tif&quot;</span>)[[<span class="dv">1</span>]]</span>
<span id="cb116-28"><a href="annex-i-compendium-of-r-scripts.html#cb116-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-29"><a href="annex-i-compendium-of-r-scripts.html#cb116-29" aria-hidden="true" tabindex="-1"></a>derived_vars</span>
<span id="cb116-30"><a href="annex-i-compendium-of-r-scripts.html#cb116-30" aria-hidden="true" tabindex="-1"></a>ref</span>
<span id="cb116-31"><a href="annex-i-compendium-of-r-scripts.html#cb116-31" aria-hidden="true" tabindex="-1"></a><span class="co"># transform the variable&#39;s coordinates, resolution and extent </span></span>
<span id="cb116-32"><a href="annex-i-compendium-of-r-scripts.html#cb116-32" aria-hidden="true" tabindex="-1"></a>resampled_vars <span class="ot">&lt;-</span> <span class="fu">project</span>(derived_vars, ref)</span>
<span id="cb116-33"><a href="annex-i-compendium-of-r-scripts.html#cb116-33" aria-hidden="true" tabindex="-1"></a><span class="co"># mask variables</span></span>
<span id="cb116-34"><a href="annex-i-compendium-of-r-scripts.html#cb116-34" aria-hidden="true" tabindex="-1"></a>resampled_vars <span class="ot">&lt;-</span> <span class="fu">mask</span>(resampled_vars, ref)</span>
<span id="cb116-35"><a href="annex-i-compendium-of-r-scripts.html#cb116-35" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(resampled_vars)</span>
<span id="cb116-36"><a href="annex-i-compendium-of-r-scripts.html#cb116-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-37"><a href="annex-i-compendium-of-r-scripts.html#cb116-37" aria-hidden="true" tabindex="-1"></a>resampled_vars</span>
<span id="cb116-38"><a href="annex-i-compendium-of-r-scripts.html#cb116-38" aria-hidden="true" tabindex="-1"></a>ref</span>
<span id="cb116-39"><a href="annex-i-compendium-of-r-scripts.html#cb116-39" aria-hidden="true" tabindex="-1"></a><span class="co"># save the rasters</span></span>
<span id="cb116-40"><a href="annex-i-compendium-of-r-scripts.html#cb116-40" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(resampled_vars, <span class="st">&quot;01-Data/covs/dem_derivatives.tif&quot;</span>)</span>
<span id="cb116-41"><a href="annex-i-compendium-of-r-scripts.html#cb116-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-42"><a href="annex-i-compendium-of-r-scripts.html#cb116-42" aria-hidden="true" tabindex="-1"></a><span class="co"># # Load a vector layer (e.g.a soil map) </span></span>
<span id="cb116-43"><a href="annex-i-compendium-of-r-scripts.html#cb116-43" aria-hidden="true" tabindex="-1"></a><span class="co"># v &lt;- vect(&quot;01-Data/AOI.shp&quot;)</span></span>
<span id="cb116-44"><a href="annex-i-compendium-of-r-scripts.html#cb116-44" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(v, &quot;shape_Area&quot;)</span></span>
<span id="cb116-45"><a href="annex-i-compendium-of-r-scripts.html#cb116-45" aria-hidden="true" tabindex="-1"></a><span class="co"># # Vector rasterization with continuous data</span></span>
<span id="cb116-46"><a href="annex-i-compendium-of-r-scripts.html#cb116-46" aria-hidden="true" tabindex="-1"></a><span class="co"># x &lt;- rasterize(x = v, y = ref, field = &quot;shape_Area&quot;, fun = &quot;max&quot;)</span></span>
<span id="cb116-47"><a href="annex-i-compendium-of-r-scripts.html#cb116-47" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(x)</span></span>
<span id="cb116-48"><a href="annex-i-compendium-of-r-scripts.html#cb116-48" aria-hidden="true" tabindex="-1"></a><span class="co"># y &lt;- rasterize(x = v, y = ref, field = &quot;CABECERA&quot;)</span></span>
<span id="cb116-49"><a href="annex-i-compendium-of-r-scripts.html#cb116-49" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb116-50"><a href="annex-i-compendium-of-r-scripts.html#cb116-50" aria-hidden="true" tabindex="-1"></a><span class="co"># writeRaster(y, &quot;01-Data/create_covariates/polygon_map.tif&quot;)</span></span></code></pre></div>
</div>
<div id="script-4-modelling-validation-and-prediction-using-soil-data-with-coordinates" class="section level2 unnumbered hasAnchor">
<h2>Script 4: Modelling, validation and prediction using soil data with coordinates<a href="annex-i-compendium-of-r-scripts.html#script-4-modelling-validation-and-prediction-using-soil-data-with-coordinates" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="annex-i-compendium-of-r-scripts.html#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">#_______________________________________________________________________________</span></span>
<span id="cb117-2"><a href="annex-i-compendium-of-r-scripts.html#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb117-3"><a href="annex-i-compendium-of-r-scripts.html#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantile Regression Forest</span></span>
<span id="cb117-4"><a href="annex-i-compendium-of-r-scripts.html#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Property Mapping</span></span>
<span id="cb117-5"><a href="annex-i-compendium-of-r-scripts.html#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb117-6"><a href="annex-i-compendium-of-r-scripts.html#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb117-7"><a href="annex-i-compendium-of-r-scripts.html#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Isabel.Luotto@fao.org</span></span>
<span id="cb117-8"><a href="annex-i-compendium-of-r-scripts.html#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="co">#          Marcos.Angelini@fao.org</span></span>
<span id="cb117-9"><a href="annex-i-compendium-of-r-scripts.html#cb117-9" aria-hidden="true" tabindex="-1"></a><span class="co">#_______________________________________________________________________________</span></span>
<span id="cb117-10"><a href="annex-i-compendium-of-r-scripts.html#cb117-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-11"><a href="annex-i-compendium-of-r-scripts.html#cb117-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Empty environment and cache </span></span>
<span id="cb117-12"><a href="annex-i-compendium-of-r-scripts.html#cb117-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb117-13"><a href="annex-i-compendium-of-r-scripts.html#cb117-13" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb117-14"><a href="annex-i-compendium-of-r-scripts.html#cb117-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-15"><a href="annex-i-compendium-of-r-scripts.html#cb117-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script =======================================================</span></span>
<span id="cb117-16"><a href="annex-i-compendium-of-r-scripts.html#cb117-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory, soil attribute, and packages</span></span>
<span id="cb117-17"><a href="annex-i-compendium-of-r-scripts.html#cb117-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - Merge soil data with environmental covariates </span></span>
<span id="cb117-18"><a href="annex-i-compendium-of-r-scripts.html#cb117-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Covariate selection</span></span>
<span id="cb117-19"><a href="annex-i-compendium-of-r-scripts.html#cb117-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Model calibration</span></span>
<span id="cb117-20"><a href="annex-i-compendium-of-r-scripts.html#cb117-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Uncertainty assessment</span></span>
<span id="cb117-21"><a href="annex-i-compendium-of-r-scripts.html#cb117-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Prediction</span></span>
<span id="cb117-22"><a href="annex-i-compendium-of-r-scripts.html#cb117-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Export final maps</span></span>
<span id="cb117-23"><a href="annex-i-compendium-of-r-scripts.html#cb117-23" aria-hidden="true" tabindex="-1"></a><span class="co">#_______________________________________________________________________________</span></span>
<span id="cb117-24"><a href="annex-i-compendium-of-r-scripts.html#cb117-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-25"><a href="annex-i-compendium-of-r-scripts.html#cb117-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-26"><a href="annex-i-compendium-of-r-scripts.html#cb117-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory, soil attribute, and packages ======================</span></span>
<span id="cb117-27"><a href="annex-i-compendium-of-r-scripts.html#cb117-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-28"><a href="annex-i-compendium-of-r-scripts.html#cb117-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Working directory</span></span>
<span id="cb117-29"><a href="annex-i-compendium-of-r-scripts.html#cb117-29" aria-hidden="true" tabindex="-1"></a>wd <span class="ot">&lt;-</span> <span class="st">&#39;C:/Users/luottoi/Documents/GitHub/GSNmap-TM/Digital-Soil-Mapping&#39;</span></span>
<span id="cb117-30"><a href="annex-i-compendium-of-r-scripts.html#cb117-30" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(wd)</span>
<span id="cb117-31"><a href="annex-i-compendium-of-r-scripts.html#cb117-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-32"><a href="annex-i-compendium-of-r-scripts.html#cb117-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Define country of interes throuhg 3-digit ISO code</span></span>
<span id="cb117-33"><a href="annex-i-compendium-of-r-scripts.html#cb117-33" aria-hidden="true" tabindex="-1"></a>ISO <span class="ot">=</span><span class="st">&#39;ISO&#39;</span></span>
<span id="cb117-34"><a href="annex-i-compendium-of-r-scripts.html#cb117-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-35"><a href="annex-i-compendium-of-r-scripts.html#cb117-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Area of interest (shp)</span></span>
<span id="cb117-36"><a href="annex-i-compendium-of-r-scripts.html#cb117-36" aria-hidden="true" tabindex="-1"></a>AOI <span class="ot">&lt;-</span> <span class="st">&#39;01-Data/AOI.shp&#39;</span></span>
<span id="cb117-37"><a href="annex-i-compendium-of-r-scripts.html#cb117-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-38"><a href="annex-i-compendium-of-r-scripts.html#cb117-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Terget soil attribute (Mandatory 10)</span></span>
<span id="cb117-39"><a href="annex-i-compendium-of-r-scripts.html#cb117-39" aria-hidden="true" tabindex="-1"></a>target_properties<span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ph_0_30&quot;</span>, <span class="st">&quot;k_0_30&quot;</span> , <span class="st">&quot;soc_0_30&quot;</span> ,<span class="st">&quot;bd_0_30&quot;</span>, <span class="st">&quot;cec_0_30&quot;</span>,<span class="st">&quot;p_0_30&quot;</span>,   </span>
<span id="cb117-40"><a href="annex-i-compendium-of-r-scripts.html#cb117-40" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;n_0_30&quot;</span>,<span class="st">&quot;clay_0_30&quot;</span>, <span class="st">&quot;sand_0_30&quot;</span> ,<span class="st">&quot;silt_0_30&quot;</span>)</span>
<span id="cb117-41"><a href="annex-i-compendium-of-r-scripts.html#cb117-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-42"><a href="annex-i-compendium-of-r-scripts.html#cb117-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for Uncertainty Assessment</span></span>
<span id="cb117-43"><a href="annex-i-compendium-of-r-scripts.html#cb117-43" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file =</span> <span class="st">&quot;03-Scripts/eval.RData&quot;</span>)</span>
<span id="cb117-44"><a href="annex-i-compendium-of-r-scripts.html#cb117-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-45"><a href="annex-i-compendium-of-r-scripts.html#cb117-45" aria-hidden="true" tabindex="-1"></a><span class="co">#load packages</span></span>
<span id="cb117-46"><a href="annex-i-compendium-of-r-scripts.html#cb117-46" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb117-47"><a href="annex-i-compendium-of-r-scripts.html#cb117-47" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb117-48"><a href="annex-i-compendium-of-r-scripts.html#cb117-48" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb117-49"><a href="annex-i-compendium-of-r-scripts.html#cb117-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quantregForest)</span>
<span id="cb117-50"><a href="annex-i-compendium-of-r-scripts.html#cb117-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb117-51"><a href="annex-i-compendium-of-r-scripts.html#cb117-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb117-52"><a href="annex-i-compendium-of-r-scripts.html#cb117-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb117-53"><a href="annex-i-compendium-of-r-scripts.html#cb117-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-54"><a href="annex-i-compendium-of-r-scripts.html#cb117-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-55"><a href="annex-i-compendium-of-r-scripts.html#cb117-55" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - Merge soil data with environmental covariates ============================</span></span>
<span id="cb117-56"><a href="annex-i-compendium-of-r-scripts.html#cb117-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-57"><a href="annex-i-compendium-of-r-scripts.html#cb117-57" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.1 - Load covariates -------------------------------------------------------</span></span>
<span id="cb117-58"><a href="annex-i-compendium-of-r-scripts.html#cb117-58" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path=</span> <span class="st">&#39;01-Data/covs/&#39;</span>, <span class="at">pattern =</span> <span class="st">&#39;.tif$&#39;</span>, <span class="at">full.names =</span> T)</span>
<span id="cb117-59"><a href="annex-i-compendium-of-r-scripts.html#cb117-59" aria-hidden="true" tabindex="-1"></a>ncovs <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path=</span> <span class="st">&#39;01-Data/covs/&#39;</span>, <span class="at">pattern =</span> <span class="st">&#39;.tif$&#39;</span>, <span class="at">full.names =</span> F)</span>
<span id="cb117-60"><a href="annex-i-compendium-of-r-scripts.html#cb117-60" aria-hidden="true" tabindex="-1"></a><span class="co">#In case of extent error, or if covariates other than the default ones are added</span></span>
<span id="cb117-61"><a href="annex-i-compendium-of-r-scripts.html#cb117-61" aria-hidden="true" tabindex="-1"></a><span class="co"># ref &lt;- rast(files[1])</span></span>
<span id="cb117-62"><a href="annex-i-compendium-of-r-scripts.html#cb117-62" aria-hidden="true" tabindex="-1"></a><span class="co"># covs &lt;- list()</span></span>
<span id="cb117-63"><a href="annex-i-compendium-of-r-scripts.html#cb117-63" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in seq_along(files)) {</span></span>
<span id="cb117-64"><a href="annex-i-compendium-of-r-scripts.html#cb117-64" aria-hidden="true" tabindex="-1"></a><span class="co">#   r &lt;- rast(files[i])</span></span>
<span id="cb117-65"><a href="annex-i-compendium-of-r-scripts.html#cb117-65" aria-hidden="true" tabindex="-1"></a><span class="co">#   r &lt;- project(r, ref)</span></span>
<span id="cb117-66"><a href="annex-i-compendium-of-r-scripts.html#cb117-66" aria-hidden="true" tabindex="-1"></a><span class="co">#   covs[[i]] &lt;- r</span></span>
<span id="cb117-67"><a href="annex-i-compendium-of-r-scripts.html#cb117-67" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb117-68"><a href="annex-i-compendium-of-r-scripts.html#cb117-68" aria-hidden="true" tabindex="-1"></a><span class="co"># covs &lt;- rast(covs)</span></span>
<span id="cb117-69"><a href="annex-i-compendium-of-r-scripts.html#cb117-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-70"><a href="annex-i-compendium-of-r-scripts.html#cb117-70" aria-hidden="true" tabindex="-1"></a>covs<span class="ot">&lt;-</span> <span class="fu">rast</span>(files)</span>
<span id="cb117-71"><a href="annex-i-compendium-of-r-scripts.html#cb117-71" aria-hidden="true" tabindex="-1"></a>ncovs <span class="ot">&lt;-</span>  filename <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">&#39;.tif&#39;</span>, <span class="st">&#39;&#39;</span>, ncovs)</span>
<span id="cb117-72"><a href="annex-i-compendium-of-r-scripts.html#cb117-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-73"><a href="annex-i-compendium-of-r-scripts.html#cb117-73" aria-hidden="true" tabindex="-1"></a>ncovs[ncovs<span class="sc">==</span><span class="st">&quot;dtm_neg-openness_250m&quot;</span>] <span class="ot">=</span> <span class="st">&#39;dtm_neg&#39;</span></span>
<span id="cb117-74"><a href="annex-i-compendium-of-r-scripts.html#cb117-74" aria-hidden="true" tabindex="-1"></a>ncovs[ncovs<span class="sc">==</span><span class="st">&quot;dtm_pos-openness_250m&quot;</span>] <span class="ot">=</span> <span class="st">&#39;dtm_pos&#39;</span></span>
<span id="cb117-75"><a href="annex-i-compendium-of-r-scripts.html#cb117-75" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(covs) <span class="ot">&lt;-</span> ncovs</span>
<span id="cb117-76"><a href="annex-i-compendium-of-r-scripts.html#cb117-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-77"><a href="annex-i-compendium-of-r-scripts.html#cb117-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-78"><a href="annex-i-compendium-of-r-scripts.html#cb117-78" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.2 - Load the soil data (Script 2) -----------------------------------------</span></span>
<span id="cb117-79"><a href="annex-i-compendium-of-r-scripts.html#cb117-79" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;02-Outputs/harmonized_soil_data.csv&quot;</span>)</span>
<span id="cb117-80"><a href="annex-i-compendium-of-r-scripts.html#cb117-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-81"><a href="annex-i-compendium-of-r-scripts.html#cb117-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert soil data into a spatial object (check https://epsg.io/6204)</span></span>
<span id="cb117-82"><a href="annex-i-compendium-of-r-scripts.html#cb117-82" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">vect</span>(dat, <span class="at">geom=</span><span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="fu">crs</span>(covs))</span>
<span id="cb117-83"><a href="annex-i-compendium-of-r-scripts.html#cb117-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-84"><a href="annex-i-compendium-of-r-scripts.html#cb117-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject point coordinates to match coordinate system of covariates</span></span>
<span id="cb117-85"><a href="annex-i-compendium-of-r-scripts.html#cb117-85" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(dat, covs)</span>
<span id="cb117-86"><a href="annex-i-compendium-of-r-scripts.html#cb117-86" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(dat)</span>
<span id="cb117-87"><a href="annex-i-compendium-of-r-scripts.html#cb117-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-88"><a href="annex-i-compendium-of-r-scripts.html#cb117-88" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.3 - Extract values from covariates to the soil points ---------------------</span></span>
<span id="cb117-89"><a href="annex-i-compendium-of-r-scripts.html#cb117-89" aria-hidden="true" tabindex="-1"></a>pv <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(<span class="at">x =</span> covs, <span class="at">y =</span> dat, <span class="at">xy=</span>F)</span>
<span id="cb117-90"><a href="annex-i-compendium-of-r-scripts.html#cb117-90" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dat,pv)</span>
<span id="cb117-91"><a href="annex-i-compendium-of-r-scripts.html#cb117-91" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dat)</span>
<span id="cb117-92"><a href="annex-i-compendium-of-r-scripts.html#cb117-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-93"><a href="annex-i-compendium-of-r-scripts.html#cb117-93" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat)</span>
<span id="cb117-94"><a href="annex-i-compendium-of-r-scripts.html#cb117-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-95"><a href="annex-i-compendium-of-r-scripts.html#cb117-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-96"><a href="annex-i-compendium-of-r-scripts.html#cb117-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-97"><a href="annex-i-compendium-of-r-scripts.html#cb117-97" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(soilatt <span class="cf">in</span> <span class="fu">unique</span>(target_properties)){</span>
<span id="cb117-98"><a href="annex-i-compendium-of-r-scripts.html#cb117-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-99"><a href="annex-i-compendium-of-r-scripts.html#cb117-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-100"><a href="annex-i-compendium-of-r-scripts.html#cb117-100" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.4 - Target soil attribute + covariates ------------------------------------</span></span>
<span id="cb117-101"><a href="annex-i-compendium-of-r-scripts.html#cb117-101" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(dat, soilatt, <span class="fu">names</span>(covs))</span>
<span id="cb117-102"><a href="annex-i-compendium-of-r-scripts.html#cb117-102" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(d)</span>
<span id="cb117-103"><a href="annex-i-compendium-of-r-scripts.html#cb117-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-104"><a href="annex-i-compendium-of-r-scripts.html#cb117-104" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Covariate selection with RFE =============================================</span></span>
<span id="cb117-105"><a href="annex-i-compendium-of-r-scripts.html#cb117-105" aria-hidden="true" tabindex="-1"></a><span class="do">## 2.1 - Setting parameters ----------------------------------------------------</span></span>
<span id="cb117-106"><a href="annex-i-compendium-of-r-scripts.html#cb117-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeatedcv = 3-times repeated 10-fold cross-validation</span></span>
<span id="cb117-107"><a href="annex-i-compendium-of-r-scripts.html#cb117-107" aria-hidden="true" tabindex="-1"></a>fitControl <span class="ot">&lt;-</span> <span class="fu">rfeControl</span>(<span class="at">functions =</span> rfFuncs,</span>
<span id="cb117-108"><a href="annex-i-compendium-of-r-scripts.html#cb117-108" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">&quot;repeatedcv&quot;</span>,</span>
<span id="cb117-109"><a href="annex-i-compendium-of-r-scripts.html#cb117-109" aria-hidden="true" tabindex="-1"></a>                         <span class="at">number =</span> <span class="dv">10</span>,         <span class="do">## 10 -fold CV</span></span>
<span id="cb117-110"><a href="annex-i-compendium-of-r-scripts.html#cb117-110" aria-hidden="true" tabindex="-1"></a>                         <span class="at">repeats =</span> <span class="dv">3</span>,        <span class="do">## repeated 3 times</span></span>
<span id="cb117-111"><a href="annex-i-compendium-of-r-scripts.html#cb117-111" aria-hidden="true" tabindex="-1"></a>                         <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb117-112"><a href="annex-i-compendium-of-r-scripts.html#cb117-112" aria-hidden="true" tabindex="-1"></a>                         <span class="at">saveDetails =</span> <span class="cn">TRUE</span>, </span>
<span id="cb117-113"><a href="annex-i-compendium-of-r-scripts.html#cb117-113" aria-hidden="true" tabindex="-1"></a>                         <span class="at">returnResamp =</span> <span class="st">&quot;all&quot;</span>)</span>
<span id="cb117-114"><a href="annex-i-compendium-of-r-scripts.html#cb117-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-115"><a href="annex-i-compendium-of-r-scripts.html#cb117-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the regression function</span></span>
<span id="cb117-116"><a href="annex-i-compendium-of-r-scripts.html#cb117-116" aria-hidden="true" tabindex="-1"></a>fm <span class="ot">=</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(soilatt,<span class="st">&quot; ~&quot;</span>, <span class="fu">paste0</span>(ncovs,</span>
<span id="cb117-117"><a href="annex-i-compendium-of-r-scripts.html#cb117-117" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">collapse =</span> <span class="st">&quot;+&quot;</span>)))</span>
<span id="cb117-118"><a href="annex-i-compendium-of-r-scripts.html#cb117-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-119"><a href="annex-i-compendium-of-r-scripts.html#cb117-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibrate the model using multiple cores</span></span>
<span id="cb117-120"><a href="annex-i-compendium-of-r-scripts.html#cb117-120" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb117-121"><a href="annex-i-compendium-of-r-scripts.html#cb117-121" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb117-122"><a href="annex-i-compendium-of-r-scripts.html#cb117-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-123"><a href="annex-i-compendium-of-r-scripts.html#cb117-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-124"><a href="annex-i-compendium-of-r-scripts.html#cb117-124" aria-hidden="true" tabindex="-1"></a><span class="do">## 2.2 - Calibrate a RFE model to select covariates ----------------------------</span></span>
<span id="cb117-125"><a href="annex-i-compendium-of-r-scripts.html#cb117-125" aria-hidden="true" tabindex="-1"></a>covsel <span class="ot">&lt;-</span> <span class="fu">rfe</span>(fm,</span>
<span id="cb117-126"><a href="annex-i-compendium-of-r-scripts.html#cb117-126" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> d,  </span>
<span id="cb117-127"><a href="annex-i-compendium-of-r-scripts.html#cb117-127" aria-hidden="true" tabindex="-1"></a>              <span class="at">sizes =</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="dv">10</span>, <span class="at">to=</span><span class="fu">length</span>(ncovs)<span class="sc">-</span><span class="dv">1</span>, <span class="at">by =</span> <span class="dv">5</span>),</span>
<span id="cb117-128"><a href="annex-i-compendium-of-r-scripts.html#cb117-128" aria-hidden="true" tabindex="-1"></a>              <span class="at">rfeControl =</span> fitControl,</span>
<span id="cb117-129"><a href="annex-i-compendium-of-r-scripts.html#cb117-129" aria-hidden="true" tabindex="-1"></a>              <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb117-130"><a href="annex-i-compendium-of-r-scripts.html#cb117-130" aria-hidden="true" tabindex="-1"></a>              <span class="at">keep.inbag =</span> T)</span>
<span id="cb117-131"><a href="annex-i-compendium-of-r-scripts.html#cb117-131" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb117-132"><a href="annex-i-compendium-of-r-scripts.html#cb117-132" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(covsel, <span class="st">&quot;02-Outputs/models/covsel.rda&quot;</span>)</span>
<span id="cb117-133"><a href="annex-i-compendium-of-r-scripts.html#cb117-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-134"><a href="annex-i-compendium-of-r-scripts.html#cb117-134" aria-hidden="true" tabindex="-1"></a><span class="do">## 2.3 - Plot selection of covariates ------------------------------------------</span></span>
<span id="cb117-135"><a href="annex-i-compendium-of-r-scripts.html#cb117-135" aria-hidden="true" tabindex="-1"></a><span class="fu">trellis.par.set</span>(<span class="fu">caretTheme</span>())</span>
<span id="cb117-136"><a href="annex-i-compendium-of-r-scripts.html#cb117-136" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(covsel, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;g&quot;</span>, <span class="st">&quot;o&quot;</span>))</span>
<span id="cb117-137"><a href="annex-i-compendium-of-r-scripts.html#cb117-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-138"><a href="annex-i-compendium-of-r-scripts.html#cb117-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract selection of covariates and subset covs</span></span>
<span id="cb117-139"><a href="annex-i-compendium-of-r-scripts.html#cb117-139" aria-hidden="true" tabindex="-1"></a>opt_covs <span class="ot">&lt;-</span> <span class="fu">predictors</span>(covsel)</span>
<span id="cb117-140"><a href="annex-i-compendium-of-r-scripts.html#cb117-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-141"><a href="annex-i-compendium-of-r-scripts.html#cb117-141" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - QRF Model calibration ====================================================</span></span>
<span id="cb117-142"><a href="annex-i-compendium-of-r-scripts.html#cb117-142" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.1 - Update formula with the selected covariates ---------------------------</span></span>
<span id="cb117-143"><a href="annex-i-compendium-of-r-scripts.html#cb117-143" aria-hidden="true" tabindex="-1"></a>fm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(soilatt,<span class="st">&quot; ~&quot;</span>, <span class="fu">paste0</span>(opt_covs, <span class="at">collapse =</span> <span class="st">&quot;+&quot;</span>)))</span>
<span id="cb117-144"><a href="annex-i-compendium-of-r-scripts.html#cb117-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-145"><a href="annex-i-compendium-of-r-scripts.html#cb117-145" aria-hidden="true" tabindex="-1"></a><span class="co"># parallel processing</span></span>
<span id="cb117-146"><a href="annex-i-compendium-of-r-scripts.html#cb117-146" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb117-147"><a href="annex-i-compendium-of-r-scripts.html#cb117-147" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb117-148"><a href="annex-i-compendium-of-r-scripts.html#cb117-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-149"><a href="annex-i-compendium-of-r-scripts.html#cb117-149" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.2 - Set training parameters -----------------------------------------------</span></span>
<span id="cb117-150"><a href="annex-i-compendium-of-r-scripts.html#cb117-150" aria-hidden="true" tabindex="-1"></a>fitControl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;repeatedcv&quot;</span>,</span>
<span id="cb117-151"><a href="annex-i-compendium-of-r-scripts.html#cb117-151" aria-hidden="true" tabindex="-1"></a>                           <span class="at">number =</span> <span class="dv">10</span>,         <span class="do">## 10 -fold CV</span></span>
<span id="cb117-152"><a href="annex-i-compendium-of-r-scripts.html#cb117-152" aria-hidden="true" tabindex="-1"></a>                           <span class="at">repeats =</span> <span class="dv">3</span>,        <span class="do">## repeated 3 times</span></span>
<span id="cb117-153"><a href="annex-i-compendium-of-r-scripts.html#cb117-153" aria-hidden="true" tabindex="-1"></a>                           <span class="at">savePredictions =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-154"><a href="annex-i-compendium-of-r-scripts.html#cb117-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-155"><a href="annex-i-compendium-of-r-scripts.html#cb117-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune mtry hyperparameters</span></span>
<span id="cb117-156"><a href="annex-i-compendium-of-r-scripts.html#cb117-156" aria-hidden="true" tabindex="-1"></a>mtry <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">length</span>(opt_covs)<span class="sc">/</span><span class="dv">3</span>)</span>
<span id="cb117-157"><a href="annex-i-compendium-of-r-scripts.html#cb117-157" aria-hidden="true" tabindex="-1"></a>tuneGrid <span class="ot">&lt;-</span>  <span class="fu">expand.grid</span>(<span class="at">mtry =</span> <span class="fu">c</span>(mtry<span class="dv">-5</span>, mtry, mtry<span class="sc">+</span><span class="dv">5</span>))</span>
<span id="cb117-158"><a href="annex-i-compendium-of-r-scripts.html#cb117-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-159"><a href="annex-i-compendium-of-r-scripts.html#cb117-159" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.3 - Calibrate the QRF model -----------------------------------------------</span></span>
<span id="cb117-160"><a href="annex-i-compendium-of-r-scripts.html#cb117-160" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(fm,</span>
<span id="cb117-161"><a href="annex-i-compendium-of-r-scripts.html#cb117-161" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> d,</span>
<span id="cb117-162"><a href="annex-i-compendium-of-r-scripts.html#cb117-162" aria-hidden="true" tabindex="-1"></a>                      <span class="at">method =</span> <span class="st">&quot;qrf&quot;</span>,</span>
<span id="cb117-163"><a href="annex-i-compendium-of-r-scripts.html#cb117-163" aria-hidden="true" tabindex="-1"></a>                      <span class="at">trControl =</span> fitControl,</span>
<span id="cb117-164"><a href="annex-i-compendium-of-r-scripts.html#cb117-164" aria-hidden="true" tabindex="-1"></a>                      <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb117-165"><a href="annex-i-compendium-of-r-scripts.html#cb117-165" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tuneGrid =</span> tuneGrid,</span>
<span id="cb117-166"><a href="annex-i-compendium-of-r-scripts.html#cb117-166" aria-hidden="true" tabindex="-1"></a>                      <span class="at">keep.inbag =</span> T,</span>
<span id="cb117-167"><a href="annex-i-compendium-of-r-scripts.html#cb117-167" aria-hidden="true" tabindex="-1"></a>                      <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-168"><a href="annex-i-compendium-of-r-scripts.html#cb117-168" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb117-169"><a href="annex-i-compendium-of-r-scripts.html#cb117-169" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb117-170"><a href="annex-i-compendium-of-r-scripts.html#cb117-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-171"><a href="annex-i-compendium-of-r-scripts.html#cb117-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-172"><a href="annex-i-compendium-of-r-scripts.html#cb117-172" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.4 - Extract predictor importance as relative values (%)</span></span>
<span id="cb117-173"><a href="annex-i-compendium-of-r-scripts.html#cb117-173" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> randomForest<span class="sc">::</span><span class="fu">importance</span>(model<span class="sc">$</span>finalModel)</span>
<span id="cb117-174"><a href="annex-i-compendium-of-r-scripts.html#cb117-174" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>importance <span class="ot">&lt;-</span> x</span>
<span id="cb117-175"><a href="annex-i-compendium-of-r-scripts.html#cb117-175" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.5 - Print and save model --------------------------------------------------</span></span>
<span id="cb117-176"><a href="annex-i-compendium-of-r-scripts.html#cb117-176" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model)</span>
<span id="cb117-177"><a href="annex-i-compendium-of-r-scripts.html#cb117-177" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(model, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/models/model_&quot;</span>,soilatt,<span class="st">&quot;.rds&quot;</span>))</span>
<span id="cb117-178"><a href="annex-i-compendium-of-r-scripts.html#cb117-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-179"><a href="annex-i-compendium-of-r-scripts.html#cb117-179" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Uncertainty assessment ===================================================</span></span>
<span id="cb117-180"><a href="annex-i-compendium-of-r-scripts.html#cb117-180" aria-hidden="true" tabindex="-1"></a><span class="co"># extract observed and predicted values</span></span>
<span id="cb117-181"><a href="annex-i-compendium-of-r-scripts.html#cb117-181" aria-hidden="true" tabindex="-1"></a>o <span class="ot">&lt;-</span> model<span class="sc">$</span>pred<span class="sc">$</span>obs</span>
<span id="cb117-182"><a href="annex-i-compendium-of-r-scripts.html#cb117-182" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> model<span class="sc">$</span>pred<span class="sc">$</span>pred</span>
<span id="cb117-183"><a href="annex-i-compendium-of-r-scripts.html#cb117-183" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(o,p)</span>
<span id="cb117-184"><a href="annex-i-compendium-of-r-scripts.html#cb117-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-185"><a href="annex-i-compendium-of-r-scripts.html#cb117-185" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.1 - Plot and save scatterplot --------------------------------------------- </span></span>
<span id="cb117-186"><a href="annex-i-compendium-of-r-scripts.html#cb117-186" aria-hidden="true" tabindex="-1"></a>(g1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> o, <span class="at">y =</span> p)) <span class="sc">+</span> </span>
<span id="cb117-187"><a href="annex-i-compendium-of-r-scripts.html#cb117-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span> </span>
<span id="cb117-188"><a href="annex-i-compendium-of-r-scripts.html#cb117-188" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>)<span class="sc">+</span></span>
<span id="cb117-189"><a href="annex-i-compendium-of-r-scripts.html#cb117-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="fu">min</span>(o), <span class="fu">max</span>(o))) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">aspect.ratio=</span><span class="dv">1</span>)<span class="sc">+</span> </span>
<span id="cb117-190"><a href="annex-i-compendium-of-r-scripts.html#cb117-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> soilatt) <span class="sc">+</span> </span>
<span id="cb117-191"><a href="annex-i-compendium-of-r-scripts.html#cb117-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Observed&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Predicted&quot;</span>))</span>
<span id="cb117-192"><a href="annex-i-compendium-of-r-scripts.html#cb117-192" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave(g1, filename = paste0(&quot;02-Outputs/residuals_&quot;,soilatt,&quot;.png&quot;), scale = 1, </span></span>
<span id="cb117-193"><a href="annex-i-compendium-of-r-scripts.html#cb117-193" aria-hidden="true" tabindex="-1"></a><span class="co">#        units = &quot;cm&quot;, width = 12, height = 12)</span></span>
<span id="cb117-194"><a href="annex-i-compendium-of-r-scripts.html#cb117-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-195"><a href="annex-i-compendium-of-r-scripts.html#cb117-195" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.2 - Print accuracy coeficients --------------------------------------------</span></span>
<span id="cb117-196"><a href="annex-i-compendium-of-r-scripts.html#cb117-196" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/AlexandreWadoux/MapQualityEvaluation</span></span>
<span id="cb117-197"><a href="annex-i-compendium-of-r-scripts.html#cb117-197" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(p,o)</span>
<span id="cb117-198"><a href="annex-i-compendium-of-r-scripts.html#cb117-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-199"><a href="annex-i-compendium-of-r-scripts.html#cb117-199" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.3 - Plot Covariate importance ---------------------------------------------</span></span>
<span id="cb117-200"><a href="annex-i-compendium-of-r-scripts.html#cb117-200" aria-hidden="true" tabindex="-1"></a>(g2 <span class="ot">&lt;-</span> <span class="fu">varImpPlot</span>(model<span class="sc">$</span>finalModel, <span class="at">main =</span> soilatt, <span class="at">type =</span> <span class="dv">1</span>))</span>
<span id="cb117-201"><a href="annex-i-compendium-of-r-scripts.html#cb117-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-202"><a href="annex-i-compendium-of-r-scripts.html#cb117-202" aria-hidden="true" tabindex="-1"></a><span class="co"># png(filename = paste0(&quot;02-Outputs/importance_&quot;,soilatt,&quot;.png&quot;), </span></span>
<span id="cb117-203"><a href="annex-i-compendium-of-r-scripts.html#cb117-203" aria-hidden="true" tabindex="-1"></a><span class="co">#     width = 15, height = 15, units = &quot;cm&quot;, res = 600)</span></span>
<span id="cb117-204"><a href="annex-i-compendium-of-r-scripts.html#cb117-204" aria-hidden="true" tabindex="-1"></a><span class="co"># g2</span></span>
<span id="cb117-205"><a href="annex-i-compendium-of-r-scripts.html#cb117-205" aria-hidden="true" tabindex="-1"></a><span class="co"># dev.off()</span></span>
<span id="cb117-206"><a href="annex-i-compendium-of-r-scripts.html#cb117-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-207"><a href="annex-i-compendium-of-r-scripts.html#cb117-207" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Prediction ===============================================================</span></span>
<span id="cb117-208"><a href="annex-i-compendium-of-r-scripts.html#cb117-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Generation of maps (prediction of soil attributes) </span></span>
<span id="cb117-209"><a href="annex-i-compendium-of-r-scripts.html#cb117-209" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.1 - Produce tiles ---------------------------------------------------------</span></span>
<span id="cb117-210"><a href="annex-i-compendium-of-r-scripts.html#cb117-210" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span>covs[[<span class="dv">1</span>]]</span>
<span id="cb117-211"><a href="annex-i-compendium-of-r-scripts.html#cb117-211" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="at">nrows =</span> <span class="dv">5</span>, <span class="at">ncols =</span> <span class="dv">5</span>, <span class="at">extent =</span> <span class="fu">ext</span>(r), <span class="at">crs =</span> <span class="fu">crs</span>(r))</span>
<span id="cb117-212"><a href="annex-i-compendium-of-r-scripts.html#cb117-212" aria-hidden="true" tabindex="-1"></a>tile <span class="ot">&lt;-</span> <span class="fu">makeTiles</span>(r, t,<span class="at">overwrite=</span><span class="cn">TRUE</span>,<span class="at">filename=</span><span class="st">&quot;02-Outputs/tiles/tiles.tif&quot;</span>)</span>
<span id="cb117-213"><a href="annex-i-compendium-of-r-scripts.html#cb117-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-214"><a href="annex-i-compendium-of-r-scripts.html#cb117-214" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.2 - Predict soil attributes per tiles -------------------------------------</span></span>
<span id="cb117-215"><a href="annex-i-compendium-of-r-scripts.html#cb117-215" aria-hidden="true" tabindex="-1"></a><span class="co"># loop to predict on each tile</span></span>
<span id="cb117-216"><a href="annex-i-compendium-of-r-scripts.html#cb117-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-217"><a href="annex-i-compendium-of-r-scripts.html#cb117-217" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_along</span>(tile)) {</span>
<span id="cb117-218"><a href="annex-i-compendium-of-r-scripts.html#cb117-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb117-219"><a href="annex-i-compendium-of-r-scripts.html#cb117-219" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">rast</span>(tile[j])</span>
<span id="cb117-220"><a href="annex-i-compendium-of-r-scripts.html#cb117-220" aria-hidden="true" tabindex="-1"></a>  covst <span class="ot">&lt;-</span> <span class="fu">crop</span>(covs, t)</span>
<span id="cb117-221"><a href="annex-i-compendium-of-r-scripts.html#cb117-221" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-222"><a href="annex-i-compendium-of-r-scripts.html#cb117-222" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-223"><a href="annex-i-compendium-of-r-scripts.html#cb117-223" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot(r)# </span></span>
<span id="cb117-224"><a href="annex-i-compendium-of-r-scripts.html#cb117-224" aria-hidden="true" tabindex="-1"></a>  pred_mean <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">predict</span>(covst, <span class="at">model =</span> model<span class="sc">$</span>finalModel, <span class="at">na.rm=</span><span class="cn">TRUE</span>,  </span>
<span id="cb117-225"><a href="annex-i-compendium-of-r-scripts.html#cb117-225" aria-hidden="true" tabindex="-1"></a>                              <span class="at">cpkgs=</span><span class="st">&quot;quantregForest&quot;</span>, <span class="at">what=</span>mean)</span>
<span id="cb117-226"><a href="annex-i-compendium-of-r-scripts.html#cb117-226" aria-hidden="true" tabindex="-1"></a>  pred_sd <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">predict</span>(covst, <span class="at">model =</span> model<span class="sc">$</span>finalModel, <span class="at">na.rm=</span><span class="cn">TRUE</span>,  </span>
<span id="cb117-227"><a href="annex-i-compendium-of-r-scripts.html#cb117-227" aria-hidden="true" tabindex="-1"></a>                            <span class="at">cpkgs=</span><span class="st">&quot;quantregForest&quot;</span>, <span class="at">what=</span>sd)  </span>
<span id="cb117-228"><a href="annex-i-compendium-of-r-scripts.html#cb117-228" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-229"><a href="annex-i-compendium-of-r-scripts.html#cb117-229" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-230"><a href="annex-i-compendium-of-r-scripts.html#cb117-230" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-231"><a href="annex-i-compendium-of-r-scripts.html#cb117-231" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ###### Raster package solution (in case terra results in many NA pixels)</span></span>
<span id="cb117-232"><a href="annex-i-compendium-of-r-scripts.html#cb117-232" aria-hidden="true" tabindex="-1"></a>  <span class="co"># library(raster)</span></span>
<span id="cb117-233"><a href="annex-i-compendium-of-r-scripts.html#cb117-233" aria-hidden="true" tabindex="-1"></a>  <span class="co"># covst &lt;- stack(covst)</span></span>
<span id="cb117-234"><a href="annex-i-compendium-of-r-scripts.html#cb117-234" aria-hidden="true" tabindex="-1"></a>  <span class="co"># class(final_mod$finalModel) &lt;-&quot;quantregForest&quot;</span></span>
<span id="cb117-235"><a href="annex-i-compendium-of-r-scripts.html#cb117-235" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Estimate model uncertainty</span></span>
<span id="cb117-236"><a href="annex-i-compendium-of-r-scripts.html#cb117-236" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pred_sd &lt;- predict(covst,model=final_mod$finalModel,type=sd)</span></span>
<span id="cb117-237"><a href="annex-i-compendium-of-r-scripts.html#cb117-237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # OCSKGMlog prediction based in all available data</span></span>
<span id="cb117-238"><a href="annex-i-compendium-of-r-scripts.html#cb117-238" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pred_mean &lt;- predict(covst,model=final_mod)</span></span>
<span id="cb117-239"><a href="annex-i-compendium-of-r-scripts.html#cb117-239" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb117-240"><a href="annex-i-compendium-of-r-scripts.html#cb117-240" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb117-241"><a href="annex-i-compendium-of-r-scripts.html#cb117-241" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ##################################  </span></span>
<span id="cb117-242"><a href="annex-i-compendium-of-r-scripts.html#cb117-242" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-243"><a href="annex-i-compendium-of-r-scripts.html#cb117-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeRaster</span>(pred_mean, </span>
<span id="cb117-244"><a href="annex-i-compendium-of-r-scripts.html#cb117-244" aria-hidden="true" tabindex="-1"></a>              <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>,</span>
<span id="cb117-245"><a href="annex-i-compendium-of-r-scripts.html#cb117-245" aria-hidden="true" tabindex="-1"></a>                                soilatt,<span class="st">&quot;_tile_&quot;</span>, j, <span class="st">&quot;.tif&quot;</span>), </span>
<span id="cb117-246"><a href="annex-i-compendium-of-r-scripts.html#cb117-246" aria-hidden="true" tabindex="-1"></a>              <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-247"><a href="annex-i-compendium-of-r-scripts.html#cb117-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeRaster</span>(pred_sd, </span>
<span id="cb117-248"><a href="annex-i-compendium-of-r-scripts.html#cb117-248" aria-hidden="true" tabindex="-1"></a>              <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>,</span>
<span id="cb117-249"><a href="annex-i-compendium-of-r-scripts.html#cb117-249" aria-hidden="true" tabindex="-1"></a>                                soilatt,<span class="st">&quot;_tileSD_&quot;</span>, j, <span class="st">&quot;.tif&quot;</span>), </span>
<span id="cb117-250"><a href="annex-i-compendium-of-r-scripts.html#cb117-250" aria-hidden="true" tabindex="-1"></a>              <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-251"><a href="annex-i-compendium-of-r-scripts.html#cb117-251" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-252"><a href="annex-i-compendium-of-r-scripts.html#cb117-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(pred_mean)</span>
<span id="cb117-253"><a href="annex-i-compendium-of-r-scripts.html#cb117-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(pred_sd)</span>
<span id="cb117-254"><a href="annex-i-compendium-of-r-scripts.html#cb117-254" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-255"><a href="annex-i-compendium-of-r-scripts.html#cb117-255" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-256"><a href="annex-i-compendium-of-r-scripts.html#cb117-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;tile&quot;</span>,tile[j]))</span>
<span id="cb117-257"><a href="annex-i-compendium-of-r-scripts.html#cb117-257" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb117-258"><a href="annex-i-compendium-of-r-scripts.html#cb117-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-259"><a href="annex-i-compendium-of-r-scripts.html#cb117-259" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.3 - Merge tiles both prediction and st.Dev --------------------------------</span></span>
<span id="cb117-260"><a href="annex-i-compendium-of-r-scripts.html#cb117-260" aria-hidden="true" tabindex="-1"></a>f_mean <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>, </span>
<span id="cb117-261"><a href="annex-i-compendium-of-r-scripts.html#cb117-261" aria-hidden="true" tabindex="-1"></a>                     <span class="at">pattern =</span> <span class="fu">paste0</span>(soilatt,<span class="st">&quot;_tile_&quot;</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-262"><a href="annex-i-compendium-of-r-scripts.html#cb117-262" aria-hidden="true" tabindex="-1"></a>f_sd <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>, </span>
<span id="cb117-263"><a href="annex-i-compendium-of-r-scripts.html#cb117-263" aria-hidden="true" tabindex="-1"></a>                   <span class="at">pattern =</span>  <span class="fu">paste0</span>(soilatt,<span class="st">&quot;_tileSD_&quot;</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-264"><a href="annex-i-compendium-of-r-scripts.html#cb117-264" aria-hidden="true" tabindex="-1"></a>r_mean_l <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb117-265"><a href="annex-i-compendium-of-r-scripts.html#cb117-265" aria-hidden="true" tabindex="-1"></a>r_sd_l <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb117-266"><a href="annex-i-compendium-of-r-scripts.html#cb117-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-267"><a href="annex-i-compendium-of-r-scripts.html#cb117-267" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (g <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(f_mean)){</span>
<span id="cb117-268"><a href="annex-i-compendium-of-r-scripts.html#cb117-268" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">rast</span>(f_mean[g])</span>
<span id="cb117-269"><a href="annex-i-compendium-of-r-scripts.html#cb117-269" aria-hidden="true" tabindex="-1"></a>  r_mean_l[g] <span class="ot">&lt;-</span>r</span>
<span id="cb117-270"><a href="annex-i-compendium-of-r-scripts.html#cb117-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(r)</span>
<span id="cb117-271"><a href="annex-i-compendium-of-r-scripts.html#cb117-271" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb117-272"><a href="annex-i-compendium-of-r-scripts.html#cb117-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-273"><a href="annex-i-compendium-of-r-scripts.html#cb117-273" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (g <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(f_sd)){</span>
<span id="cb117-274"><a href="annex-i-compendium-of-r-scripts.html#cb117-274" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-275"><a href="annex-i-compendium-of-r-scripts.html#cb117-275" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">rast</span>(f_sd[g])</span>
<span id="cb117-276"><a href="annex-i-compendium-of-r-scripts.html#cb117-276" aria-hidden="true" tabindex="-1"></a>  r_sd_l[g] <span class="ot">&lt;-</span>r</span>
<span id="cb117-277"><a href="annex-i-compendium-of-r-scripts.html#cb117-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(r)</span>
<span id="cb117-278"><a href="annex-i-compendium-of-r-scripts.html#cb117-278" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb117-279"><a href="annex-i-compendium-of-r-scripts.html#cb117-279" aria-hidden="true" tabindex="-1"></a>r_mean <span class="ot">&lt;-</span><span class="fu">sprc</span>(r_mean_l)</span>
<span id="cb117-280"><a href="annex-i-compendium-of-r-scripts.html#cb117-280" aria-hidden="true" tabindex="-1"></a>r_sd <span class="ot">&lt;-</span><span class="fu">sprc</span>(r_sd_l)</span>
<span id="cb117-281"><a href="annex-i-compendium-of-r-scripts.html#cb117-281" aria-hidden="true" tabindex="-1"></a>pred_mean <span class="ot">&lt;-</span> <span class="fu">mosaic</span>(r_mean)</span>
<span id="cb117-282"><a href="annex-i-compendium-of-r-scripts.html#cb117-282" aria-hidden="true" tabindex="-1"></a>pred_sd <span class="ot">&lt;-</span> <span class="fu">mosaic</span>(r_sd)</span>
<span id="cb117-283"><a href="annex-i-compendium-of-r-scripts.html#cb117-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-284"><a href="annex-i-compendium-of-r-scripts.html#cb117-284" aria-hidden="true" tabindex="-1"></a>aoi <span class="ot">&lt;-</span> <span class="fu">vect</span>(AOI)</span>
<span id="cb117-285"><a href="annex-i-compendium-of-r-scripts.html#cb117-285" aria-hidden="true" tabindex="-1"></a>pred_mean <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_mean,aoi)</span>
<span id="cb117-286"><a href="annex-i-compendium-of-r-scripts.html#cb117-286" aria-hidden="true" tabindex="-1"></a>pred_sd <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_sd,aoi)</span>
<span id="cb117-287"><a href="annex-i-compendium-of-r-scripts.html#cb117-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-288"><a href="annex-i-compendium-of-r-scripts.html#cb117-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-289"><a href="annex-i-compendium-of-r-scripts.html#cb117-289" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_mean)</span>
<span id="cb117-290"><a href="annex-i-compendium-of-r-scripts.html#cb117-290" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_sd)</span>
<span id="cb117-291"><a href="annex-i-compendium-of-r-scripts.html#cb117-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-292"><a href="annex-i-compendium-of-r-scripts.html#cb117-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-293"><a href="annex-i-compendium-of-r-scripts.html#cb117-293" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Export final maps ========================================================</span></span>
<span id="cb117-294"><a href="annex-i-compendium-of-r-scripts.html#cb117-294" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.1 - Mask croplands --------------------------------------------------------</span></span>
<span id="cb117-295"><a href="annex-i-compendium-of-r-scripts.html#cb117-295" aria-hidden="true" tabindex="-1"></a>msk <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;01-Data/mask.tif&quot;</span>)</span>
<span id="cb117-296"><a href="annex-i-compendium-of-r-scripts.html#cb117-296" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(msk)</span>
<span id="cb117-297"><a href="annex-i-compendium-of-r-scripts.html#cb117-297" aria-hidden="true" tabindex="-1"></a>pred_mean <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_mean, msk)</span>
<span id="cb117-298"><a href="annex-i-compendium-of-r-scripts.html#cb117-298" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_mean)</span>
<span id="cb117-299"><a href="annex-i-compendium-of-r-scripts.html#cb117-299" aria-hidden="true" tabindex="-1"></a>pred_sd <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_sd, msk)</span>
<span id="cb117-300"><a href="annex-i-compendium-of-r-scripts.html#cb117-300" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_sd)</span>
<span id="cb117-301"><a href="annex-i-compendium-of-r-scripts.html#cb117-301" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_sd<span class="sc">/</span>pred_mean<span class="sc">*</span><span class="dv">100</span>, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">&quot;CV&quot;</span>,soilatt))</span>
<span id="cb117-302"><a href="annex-i-compendium-of-r-scripts.html#cb117-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-303"><a href="annex-i-compendium-of-r-scripts.html#cb117-303" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.2 - Save results ----------------------------------------------------------</span></span>
<span id="cb117-304"><a href="annex-i-compendium-of-r-scripts.html#cb117-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-305"><a href="annex-i-compendium-of-r-scripts.html#cb117-305" aria-hidden="true" tabindex="-1"></a><span class="co"># Harmonized naming </span></span>
<span id="cb117-306"><a href="annex-i-compendium-of-r-scripts.html#cb117-306" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (soilatt <span class="sc">==</span> <span class="st">&#39;ph_0_30&#39;</span>){</span>
<span id="cb117-307"><a href="annex-i-compendium-of-r-scripts.html#cb117-307" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span><span class="st">&#39;_GSNmap_pH_Map030.tiff&#39;</span></span>
<span id="cb117-308"><a href="annex-i-compendium-of-r-scripts.html#cb117-308" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span> (soilatt <span class="sc">==</span> <span class="st">&#39;k_0_30&#39;</span>){</span>
<span id="cb117-309"><a href="annex-i-compendium-of-r-scripts.html#cb117-309" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span><span class="st">&#39;_GSNmap_Ktot_Map030.tiff&#39;</span></span>
<span id="cb117-310"><a href="annex-i-compendium-of-r-scripts.html#cb117-310" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span> (soilatt <span class="sc">==</span> <span class="st">&#39;soc_0_30&#39;</span>){</span>
<span id="cb117-311"><a href="annex-i-compendium-of-r-scripts.html#cb117-311" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span><span class="st">&#39;_GSNmap_SOC_Map030.tiff&#39;</span></span>
<span id="cb117-312"><a href="annex-i-compendium-of-r-scripts.html#cb117-312" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span> (soilatt <span class="sc">==</span> <span class="st">&#39;clay_0_30&#39;</span>){</span>
<span id="cb117-313"><a href="annex-i-compendium-of-r-scripts.html#cb117-313" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span><span class="st">&#39;_GSNmap_Clay_Map030.tiff&#39;</span></span>
<span id="cb117-314"><a href="annex-i-compendium-of-r-scripts.html#cb117-314" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span> (soilatt <span class="sc">==</span> <span class="st">&#39;bd_0_30&#39;</span>){</span>
<span id="cb117-315"><a href="annex-i-compendium-of-r-scripts.html#cb117-315" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span><span class="st">&#39;_GSNmap_BD_Map030.tiff&#39;</span></span>
<span id="cb117-316"><a href="annex-i-compendium-of-r-scripts.html#cb117-316" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span> (soilatt <span class="sc">==</span> <span class="st">&#39;cec_0_30&#39;</span>){</span>
<span id="cb117-317"><a href="annex-i-compendium-of-r-scripts.html#cb117-317" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span><span class="st">&#39;_GSNmap_CEC_Map030.tiff&#39;</span></span>
<span id="cb117-318"><a href="annex-i-compendium-of-r-scripts.html#cb117-318" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span> (soilatt <span class="sc">==</span> <span class="st">&#39;p_0_30&#39;</span>){</span>
<span id="cb117-319"><a href="annex-i-compendium-of-r-scripts.html#cb117-319" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span><span class="st">&#39;_GSNmap_Pav_Map030.tiff&#39;</span></span>
<span id="cb117-320"><a href="annex-i-compendium-of-r-scripts.html#cb117-320" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span> (soilatt <span class="sc">==</span> <span class="st">&#39;n_0_30&#39;</span>){</span>
<span id="cb117-321"><a href="annex-i-compendium-of-r-scripts.html#cb117-321" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span><span class="st">&#39;_GSNmap_Ntot_Map030.tiff&#39;</span></span>
<span id="cb117-322"><a href="annex-i-compendium-of-r-scripts.html#cb117-322" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span> (soilatt <span class="sc">==</span> <span class="st">&#39;sand_0_30&#39;</span>){</span>
<span id="cb117-323"><a href="annex-i-compendium-of-r-scripts.html#cb117-323" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span><span class="st">&#39;_GSNmap_Sand_Map030.tiff&#39;</span></span>
<span id="cb117-324"><a href="annex-i-compendium-of-r-scripts.html#cb117-324" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span> (soilatt <span class="sc">==</span> <span class="st">&#39;silt_0_30&#39;</span>){</span>
<span id="cb117-325"><a href="annex-i-compendium-of-r-scripts.html#cb117-325" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span><span class="st">&#39;_GSNmap_Silt_Map030.tiff&#39;</span></span>
<span id="cb117-326"><a href="annex-i-compendium-of-r-scripts.html#cb117-326" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb117-327"><a href="annex-i-compendium-of-r-scripts.html#cb117-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-328"><a href="annex-i-compendium-of-r-scripts.html#cb117-328" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(pred_mean, </span>
<span id="cb117-329"><a href="annex-i-compendium-of-r-scripts.html#cb117-329" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/maps/&quot;</span>,ISO,name),</span>
<span id="cb117-330"><a href="annex-i-compendium-of-r-scripts.html#cb117-330" aria-hidden="true" tabindex="-1"></a>            <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb117-331"><a href="annex-i-compendium-of-r-scripts.html#cb117-331" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(pred_sd, </span>
<span id="cb117-332"><a href="annex-i-compendium-of-r-scripts.html#cb117-332" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/maps/&quot;</span>,ISO, <span class="st">&#39;_SD&#39;</span>,name),</span>
<span id="cb117-333"><a href="annex-i-compendium-of-r-scripts.html#cb117-333" aria-hidden="true" tabindex="-1"></a>            <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb117-334"><a href="annex-i-compendium-of-r-scripts.html#cb117-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-335"><a href="annex-i-compendium-of-r-scripts.html#cb117-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-336"><a href="annex-i-compendium-of-r-scripts.html#cb117-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-337"><a href="annex-i-compendium-of-r-scripts.html#cb117-337" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="way-forward.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="annex-ii-r-scripts-for-extra-functions.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["DSM_CG.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"fig_caption": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
